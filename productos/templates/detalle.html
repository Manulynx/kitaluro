{% extends 'base.html' %}
{% load static %}

{% block title %}{{ producto.nombre }} | Kitaluro{% endblock %}

{% block content %}
<div class="producto-detalle-container">
    <!-- Breadcrumb -->
    <nav class="breadcrumb" id="breadcrumb">
        <span>üîß Cargando...</span>
    </nav>

    <div class="producto-detalle">
        <!-- Galer√≠a de im√°genes -->
        <div class="producto-galeria">
            <div class="galeria-principal">
                <div class="imagen-principal" id="imagen-principal">
                    <div class="loading-placeholder">üîß Cargando imagen...</div>
                </div>
            </div>
            <div class="galeria-miniaturas" id="galeria-miniaturas">
                <!-- Miniaturas se cargar√°n din√°micamente -->
            </div>
        </div>

        <!-- Informaci√≥n del producto -->
        <div class="producto-info" id="producto-info">
            <div class="loading-placeholder">üîß Cargando informaci√≥n...</div>
        </div>
    </div>

    <!-- Tabs de informaci√≥n detallada -->
    <div class="producto-tabs" id="producto-tabs">
        <div class="loading-placeholder">üîß Cargando detalles...</div>
    </div>

    <!-- Productos relacionados -->
    <div class="productos-relacionados" id="productos-relacionados" style="display: none;">
        <h2>üîç Productos Relacionados</h2>
        <div class="productos-grid" id="relacionados-grid">
            <!-- Se cargar√°n din√°micamente -->
        </div>
    </div>
</div>

<style>
/* Estilos para p√°gina de detalle usando variables del tema principal */
.producto-detalle-container {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: 1rem;
    background: var(--background);
    min-height: calc(100vh - var(--header-height));
}

/* Breadcrumb simplificado */
.breadcrumb {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    font-size: 0.875rem;
    color: var(--text-muted);
    padding: 0.75rem;
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
}

.breadcrumb a {
    color: var(--primary);
    text-decoration: none;
}

.breadcrumb a:hover {
    text-decoration: underline;
}

.breadcrumb .current {
    color: var(--text-primary);
    font-weight: 500;
}

/* Layout principal */
.producto-detalle {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-bottom: 2rem;
}

/* Galer√≠a optimizada */
.producto-galeria {
    background: white;
    border-radius: var(--border-radius);
    padding: 1rem;
    box-shadow: var(--shadow-sm);
    height: fit-content;
}

.galeria-principal {
    margin-bottom: 1rem;
}

.imagen-principal {
    position: relative;
    width: 100%;
    height: 400px;
    background: var(--background);
    border-radius: var(--border-radius);
    overflow: hidden;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
}

.imagen-principal img {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

.no-image-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-muted);
    background: var(--background);
    border-radius: var(--border-radius);
}

.no-image-placeholder span {
    font-size: 3rem;
    margin-bottom: 0.5rem;
}

.badge {
    position: absolute;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    color: white;
    z-index: 1;
}

.badge-descuento {
    top: 0.5rem;
    right: 0.5rem;
    background: var(--accent);
}

.badge-destacado {
    top: 2.5rem;
    right: 0.5rem;
    background: var(--warning, #f59e0b);
}

.galeria-miniaturas {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
    gap: 0.5rem;
}

.miniatura {
    width: 100%;
    height: 60px;
    background: var(--background);
    border: 2px solid transparent;
    border-radius: var(--border-radius);
    cursor: pointer;
    overflow: hidden;
    transition: all 0.2s ease;
}

.miniatura:hover,
.miniatura.active {
    border-color: var(--primary);
}

.miniatura img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.miniatura-video {
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--background);
}

/* Informaci√≥n del producto */
.producto-info {
    background: white;
    border-radius: var(--border-radius);
    padding: 1.5rem;
    box-shadow: var(--shadow-sm);
}

.producto-titulo {
    font-size: 1.75rem;
    font-weight: 700;
    margin-bottom: 0.75rem;
    color: var(--text-primary);
    line-height: 1.2;
}

.producto-marca {
    margin-bottom: 0.75rem;
    color: var(--text-muted);
}

.producto-marca a {
    color: var(--primary);
    text-decoration: none;
    font-weight: 500;
}

.producto-rating {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.stars {
    color: #fbbf24;
    font-size: 1.1rem;
}

.stars.empty {
    color: var(--text-muted);
}

.rating-count {
    color: var(--text-muted);
    font-size: 0.875rem;
}

.producto-descripcion-corta {
    font-size: 1rem;
    color: var(--text-secondary);
    margin-bottom: 1.5rem;
    line-height: 1.6;
}

.producto-precio {
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: var(--background);
    border-radius: var(--border-radius);
}

.precio-descuento {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.precio-original {
    font-size: 1.125rem;
    color: var(--text-muted);
    text-decoration: line-through;
}

.precio-actual {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary);
}

.ahorro {
    margin-top: 0.5rem;
    color: var(--success, #16a34a);
    font-weight: 600;
    font-size: 0.875rem;
}

.producto-stock {
    margin-bottom: 1rem;
    padding: 0.75rem;
    border-radius: var(--border-radius);
    font-weight: 600;
    font-size: 0.875rem;
}

.stock-disponible {
    color: var(--success, #16a34a);
    background: rgba(22, 163, 74, 0.1);
}

.stock-bajo {
    color: var(--warning, #f59e0b);
    background: rgba(245, 158, 11, 0.1);
}

.stock-agotado {
    color: var(--accent);
    background: rgba(220, 38, 38, 0.1);
}

.producto-meta {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 1rem;
    padding: 1rem;
    background: var(--background);
    border-radius: var(--border-radius);
    font-size: 0.875rem;
}

.meta-item {
    display: flex;
    gap: 0.5rem;
}

.meta-label {
    color: var(--text-muted);
    font-weight: 600;
    min-width: 80px;
}

.meta-value {
    color: var(--text-primary);
}

.meta-value a {
    color: var(--primary);
    text-decoration: none;
}

.producto-caracteristicas {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.caracteristica {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text-secondary);
    font-size: 0.875rem;
}

.producto-acciones {
    display: flex;
    gap: 0.75rem;
}

.btn-agregar,
.btn-favorito {
    flex: 1;
    padding: 0.875rem 1rem;
    font-size: 1rem;
    font-weight: 600;
    border: none;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
}

.btn-agregar {
    background: var(--primary);
    color: white;
}

.btn-agregar:hover {
    background: var(--primary-dark, #0056b3);
}

.btn-favorito {
    background: var(--background);
    color: var(--text-primary);
    border: 1px solid var(--border);
}

.btn-favorito:hover {
    background: var(--text-muted);
    color: white;
}

/* Tabs optimizados */
.producto-tabs {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
    margin-bottom: 2rem;
}

.tabs-header {
    display: flex;
    border-bottom: 1px solid var(--border);
    background: var(--background);
}

.tab-btn {
    flex: 1;
    padding: 1rem;
    background: none;
    border: none;
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.2s ease;
    border-bottom: 2px solid transparent;
}

.tab-btn:hover {
    color: var(--primary);
    background: rgba(var(--primary-rgb), 0.05);
}

.tab-btn.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
    background: white;
}

.tabs-content {
    padding: 1.5rem;
}

.tab-panel {
    display: none;
}

.tab-panel.active {
    display: block;
}

.tabla-especificaciones {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
}

.tabla-especificaciones tr {
    border-bottom: 1px solid var(--border);
}

.tabla-especificaciones td {
    padding: 0.75rem;
    vertical-align: top;
}

.tabla-especificaciones td:first-child {
    width: 150px;
    color: var(--text-muted);
    font-weight: 600;
}

.valoraciones-lista {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.valoracion-item {
    padding: 1rem;
    border: 1px solid var(--border);
    border-radius: var(--border-radius);
    background: var(--background);
}

.valoracion-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.badge-verificado {
    margin-left: 0.5rem;
    padding: 2px 6px;
    background: var(--success, #16a34a);
    color: white;
    font-size: 0.7rem;
    border-radius: 3px;
}

.valoracion-estrellas {
    color: #fbbf24;
    margin-bottom: 0.5rem;
}

.sin-valoraciones {
    text-align: center;
    padding: 2rem;
    color: var(--text-muted);
}

/* Productos relacionados */
.productos-relacionados {
    margin-top: 2rem;
}

.productos-relacionados h2 {
    margin-bottom: 1rem;
    color: var(--text-primary);
}

/* Loading placeholder */
.loading-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    color: var(--text-muted);
    background: var(--background);
    border-radius: var(--border-radius);
}

/* Grid de productos relacionados - usar mismo estilo que productos principales */
#relacionados-grid.productos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

#relacionados-grid .product-card {
    background: white;
    border-radius: var(--border-radius);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    transition: all 0.2s ease;
    text-decoration: none;
    color: inherit;
    display: flex;
    flex-direction: column;
}

#relacionados-grid .product-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

#relacionados-grid .product-image {
    position: relative;
    aspect-ratio: 1;
    overflow: hidden;
    background: var(--background);
}

#relacionados-grid .product-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

#relacionados-grid .product-info {
    padding: 1rem;
    flex: 1;
    display: flex;
    flex-direction: column;
}

#relacionados-grid .product-name {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
    line-height: 1.3;
}

#relacionados-grid .product-rating {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    margin-bottom: 0.5rem;
    font-size: 0.8rem;
}

#relacionados-grid .product-price {
    font-weight: 700;
    color: var(--primary);
    margin-top: auto;
}

#relacionados-grid .product-actions {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    opacity: 0;
    transition: opacity 0.2s ease;
}

#relacionados-grid .product-card:hover .product-actions {
    opacity: 1;
}

#relacionados-grid .btn-quick-add {
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 0.8rem;
    box-shadow: var(--shadow-sm);
    transition: all 0.2s ease;
}

#relacionados-grid .btn-quick-add:hover {
    background: var(--primary-dark, #0056b3);
    transform: scale(1.1);
}

/* Responsive */
@media (max-width: 768px) {
    .producto-detalle-container {
        padding: 0.5rem;
    }
    
    .producto-detalle {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .imagen-principal {
        height: 280px;
    }
    
    .producto-titulo {
        font-size: 1.5rem;
    }
    
    .precio-actual {
        font-size: 1.75rem;
    }
    
    .producto-acciones {
        flex-direction: column;
    }
    
    .tabs-header {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .tab-btn {
        white-space: nowrap;
        min-width: 120px;
    }
    
    .galeria-miniaturas {
        grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
    }
    
    .miniatura {
        height: 50px;
    }
    
    #relacionados-grid.productos-grid {
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 0.75rem;
    }
}
</style>

<script>
// @ts-nocheck
let productoData = null;

// Cargar datos del producto
document.addEventListener('DOMContentLoaded', async function() {
    const slug = window.location.pathname.split('/').filter(Boolean).pop();
    await loadProducto(slug);
});

async function loadProducto(slug) {
    try {
        const response = await fetch(`/productos/${slug}/json/`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        if (!response.ok) throw new Error('Error al cargar producto');
        
        productoData = await response.json();
        renderProducto(productoData);
    } catch (error) {
        console.error('Error:', error);
        document.querySelector('.producto-detalle-container').innerHTML = `
            <div style="text-align: center; padding: 3rem; background: white; border-radius: var(--border-radius); box-shadow: var(--shadow-sm);">
                <div style="font-size: 3rem; margin-bottom: 1rem; color: var(--text-muted);">‚ö†Ô∏è</div>
                <h2 style="color: var(--text-primary); margin-bottom: 1rem;">Error al cargar el producto</h2>
                <p style="color: var(--text-secondary); margin-bottom: 2rem;">El producto no existe o hubo un error al cargarlo.</p>
                <a href="/productos/" style="background: var(--primary); color: white; padding: 0.75rem 1.5rem; text-decoration: none; border-radius: var(--border-radius); font-weight: 600;">üîô Volver al Cat√°logo</a>
            </div>
        `;
    }
}

function renderProducto(producto) {
    // Actualizar t√≠tulo de la p√°gina
    document.title = `${producto.nombre} | Kitaluro`;
    
    // Renderizar breadcrumb
    renderBreadcrumb(producto);
    
    // Renderizar galer√≠a
    renderGaleria(producto);
    
    // Renderizar informaci√≥n
    renderInfo(producto);
    
    // Renderizar tabs
    renderTabs(producto);
    
    // Renderizar productos relacionados
    if (producto.productos_relacionados && producto.productos_relacionados.length > 0) {
        renderRelacionados(producto.productos_relacionados);
    }
    
    // Inicializar tabs
    setupTabs();
}

function renderBreadcrumb(producto) {
    const breadcrumb = document.getElementById('breadcrumb');
    let html = `
        <a href="/">Inicio</a>
        <span>/</span>
        <a href="/productos/">Productos</a>
        <span>/</span>
    `;
    
    if (producto.categoria) {
        html += `
            <a href="/productos/?categoria=${producto.categoria_slug}">${producto.categoria}</a>
            <span>/</span>
        `;
    }
    
    if (producto.subcategoria) {
        html += `
            <a href="/productos/?subcategoria=${producto.subcategoria_slug}">${producto.subcategoria}</a>
            <span>/</span>
        `;
    }
    
    html += `<span class="current">${producto.nombre}</span>`;
    breadcrumb.innerHTML = html;
}

function renderGaleria(producto) {
    const imagenPrincipal = document.getElementById('imagen-principal');
    const miniaturas = document.getElementById('galeria-miniaturas');
    
    // Imagen principal
    let imagenHtml = '';
    if (producto.imagenes && producto.imagenes.length > 0) {
        imagenHtml = `<img src="${producto.imagenes[0].url}" alt="${producto.nombre}" id="img-principal">`;
    } else {
        imagenHtml = `
            <div class="no-image-placeholder">
                <span>üîß</span>
                <p>Sin imagen disponible</p>
            </div>
        `;
    }
    
    // Badges din√°micos del producto
    if (producto.badges && producto.badges.length > 0) {
        producto.badges.forEach(badge => {
            imagenHtml += `<div class="badge ${badge.class}">${badge.text}</div>`;
        });
    } else {
        // Fallback a badges manuales
        if (producto.tiene_descuento) {
            imagenHtml += `<div class="badge badge-descuento">-${producto.porcentaje_descuento}%</div>`;
        }
        if (producto.destacado) {
            imagenHtml += `<div class="badge badge-destacado">Destacado</div>`;
        }
        if (producto.en_oferta) {
            imagenHtml += `<div class="badge badge-oferta">üî• OFERTA</div>`;
        }
    }
    
    imagenPrincipal.innerHTML = imagenHtml;
    
    // Miniaturas (im√°genes + videos)
    let miniaturasHtml = '';
    
    if (producto.imagenes && producto.imagenes.length > 0) {
        miniaturasHtml += producto.imagenes.map((img, index) => `
            <div class="miniatura ${index === 0 ? 'active' : ''}" onclick="cambiarImagen('${img.url}', '${producto.nombre}')">
                <img src="${img.url}" alt="${producto.nombre}">
            </div>
        `).join('');
    }
    
    // Agregar miniaturas de videos
    if (producto.videos && producto.videos.length > 0) {
        miniaturasHtml += producto.videos.map((video, index) => `
            <div class="miniatura miniatura-video" onclick="mostrarVideo('${video.url}', '${video.title || 'Video del producto'}')">
                <div class="video-icon">‚ñ∂Ô∏è</div>
                <span class="video-label">Video</span>
            </div>
        `).join('');
    }
    
    miniaturas.innerHTML = miniaturasHtml;
}

function renderInfo(producto) {
    const infoContainer = document.getElementById('producto-info');
    
    let marcaHtml = '';
    if (producto.marca) {
        marcaHtml = `
            <div class="producto-marca">
                <span>Marca:</span> <a href="/productos/?marca=${producto.marca}" class="marca-link"><strong>${producto.marca}</strong></a>
            </div>
        `;
    }
    
    // Rating real con promedio
    const ratingStars = producto.rating_promedio > 0 ? '‚òÖ'.repeat(Math.round(producto.rating_promedio)) + '‚òÜ'.repeat(5 - Math.round(producto.rating_promedio)) : '‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ';
    const ratingHtml = `
        <div class="producto-rating">
            <div class="stars ${producto.total_valoraciones === 0 ? 'empty' : ''}">
                ${ratingStars}
            </div>
            <span class="rating-count">${producto.rating_promedio.toFixed(1)} (${producto.total_valoraciones} valoracion${producto.total_valoraciones !== 1 ? 'es' : ''})</span>
        </div>
    `;
    
    let precioHtml = '';
    if (producto.precio) {
        if (producto.tiene_descuento) {
            const ahorro = (parseFloat(producto.precio) - parseFloat(producto.precio_oferta)).toFixed(2);
            precioHtml = `
                <div class="precio-descuento">
                    <span class="precio-original">$${producto.precio}</span>
                    <span class="precio-actual">$${producto.precio_oferta}</span>
                </div>
                <div class="ahorro">üéâ Ahorras $${ahorro} (${producto.porcentaje_descuento}%)</div>
            `;
        } else {
            precioHtml = `<span class="precio-actual">$${producto.precio}</span>`;
        }
    } else {
        precioHtml = `<span class="precio-contacto">Consultar precio</span>`;
    }
    
    let stockHtml = '';
    if (producto.en_stock) {
        if (producto.stock <= 5) {
            stockHtml = `<span class="stock-bajo">‚ö†Ô∏è ¬°Solo quedan ${producto.stock}!</span>`;
        } else {
            stockHtml = `<span class="stock-disponible">‚úì En stock (${producto.stock} disponibles)</span>`;
        }
    } else {
        stockHtml = `<span class="stock-agotado">‚úó Agotado</span>`;
    }
    
    // Caracter√≠sticas expandidas
    let caracteristicasHtml = '';
    const hasCaracteristicas = producto.peso || producto.dimensiones || producto.origen;
    if (hasCaracteristicas) {
        caracteristicasHtml = '<div class="producto-caracteristicas">';
        if (producto.peso) {
            caracteristicasHtml += `
                <div class="caracteristica">
                    <span class="caracteristica-icono">‚öñÔ∏è</span>
                    <span>Peso: ${producto.peso} kg</span>
                </div>
            `;
        }
        if (producto.dimensiones) {
            caracteristicasHtml += `
                <div class="caracteristica">
                    <span class="caracteristica-icono">üìè</span>
                    <span>Dimensiones: ${producto.dimensiones} cm</span>
                </div>
            `;
        }
        if (producto.origen) {
            caracteristicasHtml += `
                <div class="caracteristica">
                    <span class="caracteristica-icono">üåç</span>
                    <span>Origen: ${producto.origen}</span>
                </div>
            `;
        }
        caracteristicasHtml += '</div>';
    }
    
    const accionesHtml = producto.en_stock ? `
        <!--<button class="btn btn-primary btn-agregar" onclick="agregarAlCarrito(${producto.id})">
            üõí Agregar al Carrito
        </button>-->
        <!--<button class="btn btn-secondary btn-favorito" onclick="toggleFavorito(${producto.id})">
            ‚ô° Favoritos
        </button>-->
    ` : `
        <button class="btn btn-disabled" disabled>Producto Agotado</button>
        <button class="btn btn-notify" onclick="notificarDisponibilidad(${producto.id})">Notificarme</button>
    `;
    
    // Ficha t√©cnica PDF
    let fichaTecnicaHtml = '';
    if (producto.ficha_tecnica) {
        fichaTecnicaHtml = `
            <div class="ficha-tecnica-link">
                <a href="${producto.ficha_tecnica}" target="_blank" class="btn btn-outline">
                    üìé Descargar Ficha T√©cnica (PDF)
                </a>
            </div>
        `;
    }
    
    infoContainer.innerHTML = `
        <h1 class="producto-titulo">${producto.nombre}</h1>
        ${marcaHtml}
        ${ratingHtml}
        <p class="producto-descripcion-corta">${producto.descripcion_corta}</p>
        <div class="producto-precio">${precioHtml}</div>
        <div class="producto-stock">${stockHtml}</div>
        <div class="producto-meta">
            <div class="meta-item">
                <span class="meta-label">SKU:</span>
                <span class="meta-value">${producto.sku}</span>
            </div>
            ${producto.categoria ? `
                <div class="meta-item">
                    <span class="meta-label">Categor√≠a:</span>
                    <a href="/productos/?categoria=${producto.categoria_slug}" class="meta-value">${producto.categoria}</a>
                </div>
            ` : ''}
            ${producto.subcategoria ? `
                <div class="meta-item">
                    <span class="meta-label">Subcategor√≠a:</span>
                    <a href="/productos/?subcategoria=${producto.subcategoria_slug}" class="meta-value">${producto.subcategoria}</a>
                </div>
            ` : ''}
            ${producto.proveedor ? `
                <div class="meta-item">
                    <span class="meta-label">Proveedor:</span>
                    <a href="/productos/?proveedor=${producto.proveedor}" class="meta-value">${producto.proveedor}</a>
                </div>
            ` : ''}
            ${producto.estatus ? `
                <div class="meta-item">
                    <span class="meta-label">Estatus:</span>
                    <span class="meta-value">${producto.estatus}</span>
                </div>
            ` : ''}
        </div>
        ${caracteristicasHtml}
        ${fichaTecnicaHtml}
        <div class="producto-acciones">${accionesHtml}</div>
    `;
}

function renderTabs(producto) {
    const tabsContainer = document.getElementById('producto-tabs');
    
    // Distribuci√≥n de rating
    let distribucionHtml = '';
    if (producto.distribucion_rating && producto.total_valoraciones > 0) {
        distribucionHtml = `
            <div class="rating-distribucion">
                <h4>Distribuci√≥n de calificaciones</h4>
                ${[5,4,3,2,1].map(stars => {
                    const count = producto.distribucion_rating[stars.toString()] || 0;
                    const percent = producto.total_valoraciones > 0 ? (count / producto.total_valoraciones * 100).toFixed(0) : 0;
                    return `
                        <div class="rating-bar">
                            <span class="rating-stars">${stars} ‚òÖ</span>
                            <div class="bar-container">
                                <div class="bar-fill" style="width: ${percent}%"></div>
                            </div>
                            <span class="rating-count">${count}</span>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    }
    
    let valoracionesHtml = '';
    if (producto.valoraciones && producto.valoraciones.length > 0) {
        valoracionesHtml = producto.valoraciones.map(val => `
            <div class="valoracion-item">
                <div class="valoracion-header">
                    <div class="valoracion-autor">
                        <strong>${val.usuario}</strong>
                        ${val.verificado ? '<span class="badge-verificado">‚úì Compra verificada</span>' : ''}
                    </div>
                    <div class="valoracion-fecha">${val.fecha}</div>
                </div>
                <div class="valoracion-estrellas">
                    ${'‚òÖ'.repeat(val.puntuacion)}${'‚òÜ'.repeat(5 - val.puntuacion)}
                </div>
                ${val.titulo ? `<h4 class="valoracion-titulo">${val.titulo}</h4>` : ''}
                ${val.comentario ? `<p class="valoracion-comentario">${val.comentario}</p>` : ''}
            </div>
        `).join('');
    } else {
        valoracionesHtml = `
            <div class="sin-valoraciones">
                <p>Este producto a√∫n no tiene valoraciones.</p>
                <p>¬°S√© el primero en valorarlo!</p>
            </div>
        `;
    }
    
    let especificacionesHtml = `
        <tr><td><strong>SKU</strong></td><td>${producto.sku}</td></tr>
        ${producto.marca ? `<tr><td><strong>Marca</strong></td><td>${producto.marca}</td></tr>` : ''}
        ${producto.categoria ? `<tr><td><strong>Categor√≠a</strong></td><td>${producto.categoria}</td></tr>` : ''}
        ${producto.subcategoria ? `<tr><td><strong>Subcategor√≠a</strong></td><td>${producto.subcategoria}</td></tr>` : ''}
        ${producto.proveedor ? `<tr><td><strong>Proveedor</strong></td><td>${producto.proveedor}</td></tr>` : ''}
        ${producto.estatus ? `<tr><td><strong>Estatus</strong></td><td>${producto.estatus}</td></tr>` : ''}
        ${producto.peso ? `<tr><td><strong>Peso</strong></td><td>${producto.peso} kg</td></tr>` : ''}
        ${producto.dimensiones ? `<tr><td><strong>Dimensiones</strong></td><td>${producto.dimensiones} cm</td></tr>` : ''}
        ${producto.origen ? `<tr><td><strong>Pa√≠s de Origen</strong></td><td>${producto.origen}</td></tr>` : ''}
        ${producto.fecha_creacion ? `<tr><td><strong>Fecha de Creaci√≥n</strong></td><td>${producto.fecha_creacion}</td></tr>` : ''}
    `;
    
    tabsContainer.innerHTML = `
        <div class="tabs-header">
            <button class="tab-btn active" data-tab="descripcion">Descripci√≥n</button>
            <button class="tab-btn" data-tab="especificaciones">Especificaciones</button>
            <button class="tab-btn" data-tab="valoraciones">Valoraciones (${producto.total_valoraciones})</button>
        </div>
        <div class="tabs-content">
            <div class="tab-panel active" id="tab-descripcion">
                <h3>Descripci√≥n del Producto</h3>
                <div class="descripcion-completa">${producto.descripcion.replace(/\n/g, '<br>')}</div>
            </div>
            <div class="tab-panel" id="tab-especificaciones">
                <h3>Especificaciones T√©cnicas</h3>
                <table class="tabla-especificaciones">${especificacionesHtml}</table>
            </div>
            <div class="tab-panel" id="tab-valoraciones">
                <h3>Valoraciones de Clientes</h3>
                ${distribucionHtml}
                <div class="valoraciones-lista">${valoracionesHtml}</div>
            </div>
        </div>
    `;
}

function renderRelacionados(productos) {
    const container = document.getElementById('productos-relacionados');
    const grid = document.getElementById('relacionados-grid');
    
    // Usar la misma estructura que el grid de productos principal
    grid.className = 'productos-grid';
    grid.setAttribute('data-view', 'grid');
    
    grid.innerHTML = productos.map(prod => {
        let precioHtml = '';
        if (prod.precio) {
            if (prod.precio_oferta) {
                precioHtml = `
                    <span class="price-original">${prod.precio}</span>
                    <span class="price-sale">${prod.precio_oferta}</span>
                `;
            } else {
                precioHtml = `$${prod.precio}`;
            }
        } else {
            precioHtml = '<span class="price-contact">Consultar</span>';
        }
        
        return `
            <a href="${prod.url}" class="product-card" data-product-id="${prod.id}">
                <div class="product-image">
                    <div class="image-placeholder">üîß</div>
                    ${prod.imagen_principal ? `
                        <img src="${prod.imagen_principal}" alt="${prod.nombre}" class="product-img" loading="lazy" onload="this.previousElementSibling.style.display='none';">
                    ` : `
                        <div class="product-img no-image" style="background: #f8f9fa; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #6c757d; aspect-ratio: 1; border-radius: 8px;">üîß</div>
                    `}
                </div>
                <div class="product-info">
                    <h3 class="product-name">${prod.nombre}</h3>
                    <div class="product-rating">
                        <span class="stars">${prod.rating ? '‚òÖ'.repeat(Math.round(prod.rating)) + '‚òÜ'.repeat(5 - Math.round(prod.rating)) : '‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ'}</span>
                        <span class="rating-value">${prod.rating ? prod.rating.toFixed(1) : '0.0'}</span>
                    </div>
                    <div class="product-price">${precioHtml}</div>
                </div>
                <div class="product-actions">
                    <button class="btn-quick-add" onclick="quickAdd(${prod.id}, event)" aria-label="A√±adir r√°pido">
                        üõí
                    </button>
                </div>
            </a>
        `;
    }).join('');
    
    container.style.display = 'block';
}

function cambiarImagen(url, alt) {
    const imgPrincipal = document.getElementById('img-principal');
    if (imgPrincipal) {
        imgPrincipal.src = url;
        imgPrincipal.alt = alt;
    }
    
    document.querySelectorAll('.miniatura').forEach(m => m.classList.remove('active'));
    event.target.closest('.miniatura').classList.add('active');
}

function mostrarVideo(url, title) {
    const imagenPrincipal = document.getElementById('imagen-principal');
    imagenPrincipal.innerHTML = `
        <video controls style="width: 100%; height: 100%; object-fit: contain;">
            <source src="${url}" type="video/mp4">
            Tu navegador no soporta la reproducci√≥n de video.
        </video>
    `;
    
    document.querySelectorAll('.miniatura').forEach(m => m.classList.remove('active'));
    event.target.closest('.miniatura').classList.add('active');
}

function setupTabs() {
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabPanels = document.querySelectorAll('.tab-panel');
    
    tabBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');
            
            tabBtns.forEach(b => b.classList.remove('active'));
            tabPanels.forEach(p => p.classList.remove('active'));
            
            this.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        });
    });
}

/*function agregarAlCarrito(productoId) {
    // Simular animaci√≥n de agregar al carrito
    const btn = document.querySelector('.btn-agregar');
    const originalText = btn.innerHTML;
    btn.innerHTML = '‚úì Agregado';
    btn.style.background = 'var(--success, #16a34a)';
    
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.style.background = '';
    }, 2000);
    
    // Actualizar contador del carrito
    const cartCount = document.getElementById('cart-count');
    if (cartCount) {
        const current = parseInt(cartCount.textContent || '0');
        cartCount.textContent = current + 1;
        cartCount.style.display = 'inline';
        localStorage.setItem('cartCount', current + 1);
    }
}*/

/*function toggleFavorito(productoId) {
    const btn = document.querySelector('.btn-favorito');
    if (btn.innerHTML.includes('‚ô°')) {
        btn.innerHTML = '‚ô• En Favoritos';
        btn.style.background = 'var(--accent)';
        btn.style.color = 'white';
    } else {
        btn.innerHTML = '‚ô° Favoritos';
        btn.style.background = '';
        btn.style.color = '';
    }
}*/

function notificarDisponibilidad(productoId) {
    const email = prompt('¬øQu√© correo deseas usar para recibir la notificaci√≥n?');
    if (email && email.includes('@')) {
        const btn = document.querySelector('.btn-notify');
        btn.innerHTML = '‚úì Te notificaremos';
        btn.disabled = true;
        btn.style.background = 'var(--success, #16a34a)';
        btn.style.color = 'white';
    }
}

// Funci√≥n para manejar quick add desde productos relacionados
window.quickAdd = function(productId, event) {
    event.preventDefault();
    event.stopPropagation();
    
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '‚úì';
    btn.style.background = 'var(--accent)';
    
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.style.background = '';
    }, 1500);
    
    /*// Actualizar contador del carrito
    const cartCount = document.getElementById('cart-count');
    if (cartCount) {
        const current = parseInt(cartCount.textContent || '0');
        cartCount.textContent = current + 1;
        cartCount.style.display = 'inline';
        localStorage.setItem('cartCount', current + 1);
    }*/
};
</script>

{% endblock %}
