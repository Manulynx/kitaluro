{% extends 'base.html' %}
{% load static %}

{% block title %}{% block productos_title %}Productos{% endblock %} | Kitaluro{% endblock %}

{% block content %}
<div class="productos-container">
    <header class="productos-header">
        <div class="header-top">
            <h2 class="productos-title">{% block page_title %}Productos{% endblock %}</h2>
            <div class="results-count" id="results-count">{{ productos|length }} producto{{ productos|length|pluralize }} encontrado{{ productos|length|pluralize }}</div>
        </div>
        
        <div class="productos-controls">
            <!-- Filtros m√≥viles ocultos por defecto -->
            <button class="filters-toggle mobile-only" id="filters-toggle" aria-label="Filtros">
                üîç Filtros
            </button>
            
            <!-- Ordenaci√≥n simple con select nativo -->
            <div class="sort-container">
                <label for="sort-select" class="sort-label">Ordenar:</label>
                <select id="sort-select" class="sort-select">
                    <option value="relevance">Relevancia</option>
                    <option value="price-asc">Precio: Menor a Mayor</option>
                    <option value="price-desc">Precio: Mayor a Menor</option>
                    <option value="rating">Mejor Valorados</option>
                    <option value="newest">M√°s Nuevos</option>
                </select>
            </div>
            
            <!-- Vista de cuadr√≠cula/lista -->
            <div class="view-toggle desktop-only">
                <button class="view-btn active" data-view="grid" aria-label="Vista cuadr√≠cula">‚äû</button>
                <button class="view-btn" data-view="list" aria-label="Vista lista">‚ò∞</button>
            </div>
        </div>
    </header>

    <!-- Overlay para filtros m√≥viles -->
    <div class="filters-overlay" id="filters-overlay"></div>
    
    <!-- Modal/Drawer de filtros m√≥viles -->
    <div class="filters-modal" id="filters-modal">
        <div class="filters-header">
            <h3>Filtros</h3>
            <button class="filters-close" id="filters-close">‚úï</button>
        </div>
        <div class="filters-content">
            <!-- Categor√≠as -->
            <div class="filter-group">
                <h4>Categor√≠as</h4>
                <div class="filter-options">
                    <label class="filter-option">
                        <input type="checkbox" name="category" value="all" checked>
                        <span>Todas (125)</span>
                    </label>
                    <label class="filter-option">
                        <input type="checkbox" name="category" value="electronics">
                        <span>Electr√≥nicos (45)</span>
                    </label>
                    <label class="filter-option">
                        <input type="checkbox" name="category" value="clothing">
                        <span>Ropa (32)</span>
                    </label>
                    <label class="filter-option">
                        <input type="checkbox" name="category" value="home">
                        <span>Hogar (28)</span>
                    </label>
                    <label class="filter-option">
                        <input type="checkbox" name="category" value="sports">
                        <span>Deportes (20)</span>
                    </label>
                </div>
            </div>
            
            <!-- Rango de precio simple -->
            <div class="filter-group">
                <h4>Precio</h4>
                <div class="price-inputs">
                    <input type="number" placeholder="M√≠n" class="price-input" id="price-min">
                    <span>-</span>
                    <input type="number" placeholder="M√°x" class="price-input" id="price-max">
                </div>
            </div>
            
            <!-- Valoraci√≥n -->
            <div class="filter-group">
                <h4>Valoraci√≥n</h4>
                <div class="filter-options">
                    <label class="filter-option">
                        <input type="radio" name="rating" value="4">
                        <span>‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ 4+ estrellas</span>
                    </label>
                    <label class="filter-option">
                        <input type="radio" name="rating" value="3">
                        <span>‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ 3+ estrellas</span>
                    </label>
                </div>
            </div>
        </div>
        <div class="filters-actions">
            <button class="btn-clear" id="clear-filters">Limpiar</button>
            <button class="btn-apply" id="apply-filters">Aplicar Filtros</button>
        </div>
    </div>
    
    <div class="productos-layout">

        <main class="productos-content">
            {% block productos_content %}
            <!-- Cuadr√≠cula de productos optimizada -->
            <div class="productos-grid" id="productos-grid" data-view="grid">
                {% for producto in productos %}
                <a href="#" class="product-card" data-product-id="{{ producto.id }}">
                    <div class="product-image">
                        <div class="image-placeholder">üîß</div>
                        {% if producto.medias.first %}
                            <img src="{{ producto.medias.first.imagen.url }}" alt="{{ producto.nombre }}" class="product-img" loading="lazy">
                        {% elif producto.imagenes.first %}
                            <img src="{{ producto.imagenes.first.imagen.url }}" alt="{{ producto.nombre }}" class="product-img" loading="lazy">
                        {% else %}
                            <img data-src="/static/img/no-image.webp" alt="{{ producto.nombre }}" class="product-img" loading="lazy">
                        {% endif %}
                    </div>
                    <div class="product-info">
                        <h3 class="product-name">{{ producto.nombre }}</h3>
                        <div class="product-rating">
                            <span class="stars">{% with avg_rating=producto.valoraciones.all|length %}{% if avg_rating %}‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ{% else %}‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ{% endif %}{% endwith %}</span>
                            <span class="rating-value">{% with avg_rating=producto.valoraciones.all|length %}{% if avg_rating %}4.{{ avg_rating }}{% else %}0.0{% endif %}{% endwith %}</span>
                        </div>
                        <div class="product-price">
                            {% if producto.precio_oferta %}
                                <span class="price-original">${{ producto.precio }}</span>
                                <span class="price-sale">${{ producto.precio_oferta }}</span>
                            {% else %}
                                ${{ producto.precio }}
                            {% endif %}
                        </div>
                    </div>
                    <div class="product-actions">
                        <button class="btn-quick-add" onclick="quickAdd({{ producto.id }}, event)" aria-label="A√±adir r√°pido">
                            üõí
                        </button>
                    </div>
                </a>
                {% empty %}
                    <div class="no-products" style="grid-column: 1/-1; text-align: center; padding: 2rem;">
                        <div class="empty-icon">üì¶</div>
                        <h3>No hay productos disponibles</h3>
                        <p>Agrega productos desde el panel de administraci√≥n</p>
                    </div>
                {% endfor %}
            </div>
            
            <!-- Estado de carga -->
            <div class="loading-state" id="loading-state" style="display: none;">
                <div class="loading-content">
                    <div class="loading-spinner">‚ü≥</div>
                    <p>Cargando productos...</p>
                </div>
            </div>
            
            <!-- Estado vac√≠o -->
            <div class="empty-state" id="empty-state" style="display: none;">
                <div class="empty-content">
                    <div class="empty-icon">üì¶</div>
                    <h3>No se encontraron productos</h3>
                    <p>Prueba ajustar los filtros o t√©rminos de b√∫squeda</p>
                    <button class="btn-clear-all" onclick="clearAllFilters()">Limpiar filtros</button>
                </div>
            </div>
            
            <!-- Bot√≥n cargar m√°s -->
            <div class="load-more-container" id="load-more-container" style="display: none;">
                <button class="btn-load-more" id="btn-load-more">Cargar M√°s Productos</button>
                <div class="load-more-info" id="load-more-info">Mostrando 20 de 125 productos</div>
            </div>

            {% endblock %}
        </main>
    </div>
</div>

<script>
// PLP Ultra-Optimizada para Low-Data
document.addEventListener('DOMContentLoaded', function() {
    // Estado de la aplicaci√≥n
    let currentPage = 1;
    let totalProducts = 0;
    let isLoading = false;
    let currentFilters = {};
    
    // Elementos DOM
    const grid = document.getElementById('productos-grid');
    const loadingState = document.getElementById('loading-state');
    const emptyState = document.getElementById('empty-state');
    const loadMoreContainer = document.getElementById('load-more-container');
    const loadMoreBtn = document.getElementById('btn-load-more');
    const loadMoreInfo = document.getElementById('load-more-info');
    const resultsCount = document.getElementById('results-count');
    
    // Filtros m√≥viles
    const filtersToggle = document.getElementById('filters-toggle');
    const filtersModal = document.getElementById('filters-modal');
    const filtersOverlay = document.getElementById('filters-overlay');
    const filtersClose = document.getElementById('filters-close');
    const applyFilters = document.getElementById('apply-filters');
    const clearFilters = document.getElementById('clear-filters');
    
    // Ordenaci√≥n
    const sortSelect = document.getElementById('sort-select');
    
    // Vista
    const viewBtns = document.querySelectorAll('.view-btn');
    
    // Productos cargados desde Django template
    const totalProducts = {{ productos|length }};
    const hasProducts = totalProducts > 0;
    
    // Inicializar
    function init() {
        setupEventListeners();
        // Los productos ya est√°n renderizados desde Django
        if (hasProducts) {
            hideLoading();
            hideEmptyState();
        } else {
            hideLoading();
            showEmptyState();
        }
    }
    
    // Event listeners
    function setupEventListeners() {
        // Filtros m√≥viles
        if (filtersToggle) {
            filtersToggle.addEventListener('click', () => openFiltersModal());
        }
        if (filtersClose) {
            filtersClose.addEventListener('click', () => closeFiltersModal());
        }
        if (filtersOverlay) {
            filtersOverlay.addEventListener('click', () => closeFiltersModal());
        }
        if (applyFilters) {
            applyFilters.addEventListener('click', () => applyCurrentFilters());
        }
        if (clearFilters) {
            clearFilters.addEventListener('click', () => clearAllFilters());
        }
        
        // Cargar m√°s
        if (loadMoreBtn) {
            loadMoreBtn.addEventListener('click', () => loadMoreProducts());
        }
        
        // Ordenaci√≥n
        if (sortSelect) {
            sortSelect.addEventListener('change', () => handleSortChange());
        }
        
        // Vista
        viewBtns.forEach(btn => {
            btn.addEventListener('click', () => toggleView(btn.dataset.view));
        });
    }
    
    // Funci√≥n simplificada - los productos se cargan desde Django
    function loadProducts(reset = false) {
        // Por ahora los productos se renderizan directamente desde Django
        // Esta funci√≥n se puede expandir m√°s tarde para AJAX/paginaci√≥n
        if (hasProducts) {
            hideEmptyState();
            // Configurar lazy loading para im√°genes existentes
            const images = grid.querySelectorAll('img[data-src]');
            images.forEach(img => lazyLoadImage(img));
        } else {
            showEmptyState();
        }
        hideLoading();
    }
    
    // Renderizar productos
    function renderProducts(products, append = false) {
        const html = products.map(product => createProductCard(product)).join('');
        
        if (append) {
            grid.insertAdjacentHTML('beforeend', html);
        } else {
            grid.innerHTML = html;
        }
        
        // Lazy loading de im√°genes
        const images = grid.querySelectorAll('img[data-src]');
        images.forEach(img => lazyLoadImage(img));
        
        hideEmptyState();
    }
    
    // Crear tarjeta de producto optimizada
    function createProductCard(product) {
        return `
            <a href="/productos/${product.id}/" class="product-card" data-product-id="${product.id}">
                <div class="product-image">
                    <div class="image-placeholder">üì¶</div>
                    <img data-src="${product.image}" alt="${product.name}" class="product-img" loading="lazy">
                </div>
                <div class="product-info">
                    <h3 class="product-name">${product.name}</h3>
                    <div class="product-rating">
                        <span class="stars">${generateStars(product.rating)}</span>
                        <span class="rating-value">${product.rating}</span>
                    </div>
                    <div class="product-price">$${product.price}</div>
                </div>
                <div class="product-actions">
                    <button class="btn-quick-add" onclick="quickAdd(${product.id}, event)" aria-label="A√±adir r√°pido">
                        üõí
                    </button>
                </div>
            </a>
        `;
    }
    
    // Generar estrellas simples
    function generateStars(rating) {
        const full = Math.floor(rating);
        const half = rating % 1 >= 0.5 ? 1 : 0;
        const empty = 5 - full - half;
        return '‚òÖ'.repeat(full) + (half ? '‚òÜ' : '') + '‚òÜ'.repeat(empty - half);
    }
    
    // Lazy loading de im√°genes
    function lazyLoadImage(img) {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const image = entry.target;
                    image.src = image.dataset.src;
                    image.onload = () => {
                        image.classList.add('loaded');
                        image.previousElementSibling.style.display = 'none';
                    };
                    observer.unobserve(image);
                }
            });
        });
        observer.observe(img);
    }
    
    // Estados de UI
    function showLoading() {
        if (loadingState) loadingState.style.display = 'flex';
    }
    
    function hideLoading() {
        if (loadingState) loadingState.style.display = 'none';
    }
    
    function showEmptyState() {
        if (emptyState) emptyState.style.display = 'flex';
        if (loadMoreContainer) loadMoreContainer.style.display = 'none';
    }
    
    function hideEmptyState() {
        if (emptyState) emptyState.style.display = 'none';
    }
    
    function updateLoadMoreState(shown, total) {
        if (shown >= total) {
            loadMoreContainer.style.display = 'none';
        } else {
            loadMoreContainer.style.display = 'block';
            loadMoreInfo.textContent = `Mostrando ${shown} de ${total} productos`;
        }
    }
    
    function updateResultsCount(count) {
        if (resultsCount) {
            resultsCount.textContent = `${count} productos encontrados`;
        }
    }
    
    // Filtros m√≥viles
    function openFiltersModal() {
        filtersModal.classList.add('active');
        filtersOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
    
    function closeFiltersModal() {
        filtersModal.classList.remove('active');
        filtersOverlay.classList.remove('active');
        document.body.style.overflow = '';
    }
    
    function applyCurrentFilters() {
        // Aplicar filtros y recargar productos
        loadProducts(true);
        closeFiltersModal();
    }
    
    // Funciones globales
    window.clearAllFilters = function() {
        // Limpiar todos los filtros
        const checkboxes = filtersModal.querySelectorAll('input[type="checkbox"]');
        const radios = filtersModal.querySelectorAll('input[type="radio"]');
        const inputs = filtersModal.querySelectorAll('input[type="number"]');
        
        checkboxes.forEach(cb => cb.checked = cb.value === 'all');
        radios.forEach(radio => radio.checked = false);
        inputs.forEach(input => input.value = '');
        
        applyCurrentFilters();
    };
    
    window.quickAdd = function(productId, event) {
        event.preventDefault();
        event.stopPropagation();
        
        // Simular a√±adir al carrito
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '‚úì';
        btn.style.background = '#dc2626';
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.style.background = '';
        }, 1000);
        
        // Actualizar contador del carrito
        const cartCount = document.getElementById('cart-count');
        if (cartCount) {
            const current = parseInt(cartCount.textContent || '0');
            cartCount.textContent = current + 1;
            cartCount.style.display = 'inline';
            localStorage.setItem('cartCount', current + 1);
        }
    };
    
    function loadMoreProducts() {
        currentPage++;
        loadProducts(false);
    }
    
    function handleSortChange() {
        loadProducts(true);
    }
    
    function toggleView(view) {
        viewBtns.forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        grid.dataset.view = view;
    }
    
    // Inicializar aplicaci√≥n
    init();
});
</script>

{% endblock %}