{% extends 'base.html' %}
{% load static %}

{% block title %}{% block productos_title %}Productos{% endblock %} | Kitaluro{% endblock %}

{% block content %}
<div class="productos-container">
    <header class="productos-header">
        <div class="header-top">
            <h2 class="productos-title">{% block page_title %}Productos{% endblock %}</h2>
            <div class="results-count" id="results-count">Cargando productos...</div>
        </div>
        
        <div class="productos-controls">
            <!-- Filtros m√≥viles ocultos por defecto -->
            <button class="filters-toggle mobile-only" id="filters-toggle" aria-label="Filtros">
                üîç Filtros
            </button>
            
            <!-- Ordenaci√≥n simple con select nativo -->
            <div class="sort-container">
                <label for="sort-select" class="sort-label">Ordenar:</label>
                <select id="sort-select" class="sort-select">
                    <option value="">Relevancia</option>
                    <option value="precio_asc">Precio: Menor a Mayor</option>
                    <option value="precio_desc">Precio: Mayor a Menor</option>
                    <option value="nombre_asc">Nombre: A-Z</option>
                    <option value="nombre_desc">Nombre: Z-A</option>
                    <option value="recientes">M√°s Recientes</option>
                    <option value="antiguos">M√°s Antiguos</option>
                </select>
            </div>
            
            <!-- Vista de cuadr√≠cula/lista -->
            <div class="view-toggle desktop-only">
                <button class="view-btn active" data-view="grid" aria-label="Vista cuadr√≠cula">‚äû</button>
                <button class="view-btn" data-view="list" aria-label="Vista lista">‚ò∞</button>
            </div>
        </div>
    </header>

    <!-- Overlay para filtros m√≥viles -->
    <div class="filters-overlay" id="filters-overlay"></div>
    
    <!-- Modal/Drawer de filtros m√≥viles -->
    <div class="filters-modal" id="filters-modal">
        <div class="filters-header">
            <h3>Filtros</h3>
            <button class="filters-close" id="filters-close">‚úï</button>
        </div>
        <div class="filters-content">
            <!-- Categor√≠as -->
            <div class="filter-group">
                <h4>Categor√≠as</h4>
                <div class="filter-options">
                    {% for categoria in categorias %}
                    <label class="filter-option">
                        <input type="radio" name="categoria" value="{{ categoria.slug }}">
                        <span>{{ categoria.nombre }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Subcategor√≠as -->
            <div class="filter-group">
                <h4>Subcategor√≠as</h4>
                <div class="filter-options">
                    {% for subcategoria in subcategorias %}
                    <label class="filter-option">
                        <input type="radio" name="subcategoria" value="{{ subcategoria.slug }}">
                        <span>{{ subcategoria.nombre }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Marcas -->
            <div class="filter-group">
                <h4>Marcas</h4>
                <div class="filter-options">
                    {% for marca in marcas %}
                    <label class="filter-option">
                        <input type="checkbox" name="marca" value="{{ marca.id }}">
                        <span>{{ marca.nombre }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Proveedores -->
            <div class="filter-group">
                <h4>Proveedores</h4>
                <div class="filter-options">
                    {% for proveedor in proveedores %}
                    <label class="filter-option">
                        <input type="checkbox" name="proveedor" value="{{ proveedor.id }}">
                        <span>{{ proveedor.nombre }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Estado -->
            <div class="filter-group">
                <h4>Estado</h4>
                <div class="filter-options">
                    <label class="filter-option">
                        <input type="checkbox" name="destacado" value="true">
                        <span>‚≠ê Destacados</span>
                    </label>
                    <label class="filter-option">
                        <input type="checkbox" name="en_oferta" value="true">
                        <span>üî• En Oferta</span>
                    </label>
                </div>
            </div>
            
            <!-- Rango de precio simple -->
            <div class="filter-group">
                <h4>Precio</h4>
                <div class="price-inputs">
                    <input type="number" placeholder="M√≠n" class="price-input" id="price-min">
                    <span>-</span>
                    <input type="number" placeholder="M√°x" class="price-input" id="price-max">
                </div>
            </div>
            
            <!-- Valoraci√≥n -->
            <div class="filter-group">
                <h4>Valoraci√≥n</h4>
                <div class="filter-options">
                    <label class="filter-option">
                        <input type="radio" name="rating" value="4">
                        <span>‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ 4+ estrellas</span>
                    </label>
                    <label class="filter-option">
                        <input type="radio" name="rating" value="3">
                        <span>‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ 3+ estrellas</span>
                    </label>
                </div>
            </div>
        </div>
        <div class="filters-actions">
            <button class="btn-clear" id="clear-filters">Limpiar</button>
            <button class="btn-apply" id="apply-filters">Aplicar Filtros</button>
        </div>
    </div>
    
    <div class="productos-layout">

        <main class="productos-content">
            {% block productos_content %}
            <!-- Cuadr√≠cula de productos optimizada -->
            <div class="productos-grid" id="productos-grid" data-view="grid">
                <!-- Los productos se cargar√°n din√°micamente con JavaScript -->
            </div>
            
            <!-- Estado de carga -->
            <div class="loading-state" id="loading-state" style="display: none;">
                <div class="loading-content">
                    <div class="loading-spinner">‚ü≥</div>
                    <p>Cargando productos...</p>
                </div>
            </div>
            
            <!-- Estado vac√≠o -->
            <div class="empty-state" id="empty-state" style="display: none;">
                <div class="empty-content">
                    <div class="empty-icon">üì¶</div>
                    <h3>No se encontraron productos</h3>
                    <p>Prueba ajustar los filtros o t√©rminos de b√∫squeda</p>
                    <button class="btn-clear-all" onclick="clearAllFilters()">Limpiar filtros</button>
                </div>
            </div>
            
            <!-- Bot√≥n cargar m√°s -->
            <div class="load-more-container" id="load-more-container" style="display: none;">
                <button class="btn-load-more" id="btn-load-more">Cargar M√°s Productos</button>
                <div class="load-more-info" id="load-more-info">Mostrando 20 de 125 productos</div>
            </div>

            {% endblock %}
        </main>
    </div>
</div>

<script>
// @ts-nocheck
// PLP Ultra-Optimizada para Low-Data
document.addEventListener('DOMContentLoaded', function() {
    // Estado de la aplicaci√≥n
    let currentPage = 1;
    let totalProductsVar = 0;
    let isLoading = false;
    let currentFilters = {};
    let allProducts = [];
    
    // Elementos DOM
    const grid = document.getElementById('productos-grid');
    const loadingState = document.getElementById('loading-state');
    const emptyState = document.getElementById('empty-state');
    const loadMoreContainer = document.getElementById('load-more-container');
    const loadMoreBtn = document.getElementById('btn-load-more');
    const loadMoreInfo = document.getElementById('load-more-info');
    const resultsCount = document.getElementById('results-count');
    
    // Filtros m√≥viles
    const filtersToggle = document.getElementById('filters-toggle');
    const filtersModal = document.getElementById('filters-modal');
    const filtersOverlay = document.getElementById('filters-overlay');
    const filtersClose = document.getElementById('filters-close');
    const applyFilters = document.getElementById('apply-filters');
    const clearFilters = document.getElementById('clear-filters');
    
    // Ordenaci√≥n
    const sortSelect = document.getElementById('sort-select');
    
    // Vista
    const viewBtns = document.querySelectorAll('.view-btn');
    
    // Inicializar
    function init() {
        setupEventListeners();
        loadProducts(true);
    }
    
    // Event listeners
    function setupEventListeners() {
        // Filtros m√≥viles
        if (filtersToggle) {
            filtersToggle.addEventListener('click', () => openFiltersModal());
        }
        if (filtersClose) {
            filtersClose.addEventListener('click', () => closeFiltersModal());
        }
        if (filtersOverlay) {
            filtersOverlay.addEventListener('click', () => closeFiltersModal());
        }
        if (applyFilters) {
            applyFilters.addEventListener('click', () => applyCurrentFilters());
        }
        if (clearFilters) {
            clearFilters.addEventListener('click', () => clearAllFilters());
        }
        
        // Cargar m√°s
        if (loadMoreBtn) {
            loadMoreBtn.addEventListener('click', () => loadMoreProducts());
        }
        
        // Ordenaci√≥n
        if (sortSelect) {
            sortSelect.addEventListener('change', () => handleSortChange());
        }
        
        // Vista
        viewBtns.forEach(btn => {
            btn.addEventListener('click', () => toggleView(btn.dataset.view));
        });
    }
    
    // Cargar productos desde el servidor
    async function loadProducts(reset = false) {
        if (isLoading) return;
        
        isLoading = true;
        showLoading();
        
        try {
            // Construir par√°metros de filtrado
            const params = new URLSearchParams();
            
            // Agregar orden si existe
            const orden = sortSelect?.value;
            if (orden) params.append('orden', orden);
            
            // Agregar filtros activos
            const categoriaChecked = document.querySelector('input[name="categoria"]:checked');
            if (categoriaChecked) params.append('categoria', categoriaChecked.value);
            
            const subcategoriaChecked = document.querySelector('input[name="subcategoria"]:checked');
            if (subcategoriaChecked) params.append('subcategoria', subcategoriaChecked.value);
            
            document.querySelectorAll('input[name="marca"]:checked').forEach(cb => {
                params.append('marca', cb.value);
            });
            
            document.querySelectorAll('input[name="proveedor"]:checked').forEach(cb => {
                params.append('proveedor', cb.value);
            });
            
            const destacadoChecked = document.querySelector('input[name="destacado"]:checked');
            if (destacadoChecked) params.append('destacado', 'true');
            
            const enOfertaChecked = document.querySelector('input[name="en_oferta"]:checked');
            if (enOfertaChecked) params.append('en_oferta', 'true');
            
            // B√∫squeda
            const urlParams = new URLSearchParams(window.location.search);
            const busqueda = urlParams.get('q');
            if (busqueda) params.append('q', busqueda);
            
            const response = await fetch('/productos/api/productos/?' + params.toString(), {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (!response.ok) throw new Error('Error al cargar productos');
            
            const data = await response.json();
            allProducts = data.productos || [];
            totalProductsVar = allProducts.length;
            
            if (reset) {
                renderProducts(allProducts, false);
            } else {
                renderProducts(allProducts, true);
            }
            
            updateResultsCount(totalProductsVar);
            
            if (totalProductsVar === 0) {
                showEmptyState();
            } else {
                hideEmptyState();
            }
        } catch (error) {
            console.error('Error:', error);
            showEmptyState();
        } finally {
            isLoading = false;
            hideLoading();
        }
    }
    
    // Renderizar productos
    function renderProducts(products, append = false) {
        if (!products || products.length === 0) {
            grid.innerHTML = `
                <div class="no-products" style="grid-column: 1/-1; text-align: center; padding: 2rem;">
                    <div class="empty-icon">üì¶</div>
                    <h3>No hay productos disponibles</h3>
                    <p>Agrega productos desde el panel de administraci√≥n</p>
                </div>
            `;
            return;
        }
        
        const html = products.map(product => createProductCard(product)).join('');
        
        if (append) {
            grid.insertAdjacentHTML('beforeend', html);
        } else {
            grid.innerHTML = html;
        }
        
        // Configurar botones de a√±adir
        setupQuickAddButtons();
        
        hideEmptyState();
    }
    
    // Crear tarjeta de producto optimizada
    function createProductCard(product) {
        const imageUrl = product.imagen_principal || '';
        
        // Precio con manejo de null
        let precioHtml = '';
        if (product.precio) {
            if (product.precio_oferta) {
                precioHtml = `
                    <span class="price-original">$${product.precio}</span>
                    <span class="price-sale">$${product.precio_oferta}</span>
                `;
            } else {
                precioHtml = `<span class="price-regular">$${product.precio}</span>`;
            }
        } else {
            precioHtml = '<span class="price-contact">Consultar</span>';
        }
        
        // Badges din√°micos
        let badgesHtml = '';
        if (product.badges && product.badges.length > 0) {
            badgesHtml = product.badges.map(badge => 
                `<span class="badge ${badge.class}">${badge.text}</span>`
            ).join('');
        } else {
            // Fallback a badges manuales
            if (product.en_oferta) badgesHtml += '<span class="badge badge-discount">OFERTA</span>';
            if (product.destacado) badgesHtml += '<span class="badge badge-featured">DESTACADO</span>';
            if (!product.en_stock) badgesHtml += '<span class="badge badge-soldout">AGOTADO</span>';
        }
        
        // Rating con n√∫mero de valoraciones
        const ratingText = product.total_valoraciones > 0 ? 
            `(${product.total_valoraciones})` : '';
        
        return `
            <a href="${product.url || '/productos/' + product.slug + '/'}" class="product-card" data-product-id="${product.id}">
                <div class="product-image">
                    ${badgesHtml ? `<div class="product-badges">${badgesHtml}</div>` : ''}
                    <div class="image-placeholder">üì¶</div>
                    ${imageUrl ? `<img src="${imageUrl}" alt="${product.nombre}" class="product-img" loading="lazy">` : ''}
                </div>
                <div class="product-info">
                    <div class="product-meta">
                        ${product.categoria ? `<span class="product-category">${product.categoria}</span>` : ''}
                        ${product.marca ? `<span class="product-brand">${product.marca}</span>` : ''}
                    </div>
                    <h3 class="product-name">${product.nombre}</h3>
                    ${product.descripcion_corta ? `<p class="product-description">${product.descripcion_corta.substring(0, 80)}${product.descripcion_corta.length > 80 ? '...' : ''}</p>` : ''}
                    <div class="product-rating">
                        <span class="stars">${generateStars(product.rating || 0)}</span>
                        <span class="rating-value">${(product.rating || 0).toFixed(1)} ${ratingText}</span>
                    </div>
                    <div class="product-price">${precioHtml}</div>
                    ${product.porcentaje_descuento > 0 ? `<div class="discount-badge">-${product.porcentaje_descuento}%</div>` : ''}
                </div>
                <div class="product-actions">
                    ${product.en_stock ? 
                        `<button class="btn-quick-add" data-product-id="${product.id}" aria-label="A√±adir r√°pido">
                            üõí A√±adir
                        </button>` :
                        `<button class="btn-notify" disabled>Agotado</button>`
                    }
                </div>
            </a>
        `;
    }
    
    // Generar estrellas simples
    function generateStars(rating) {
        const full = Math.floor(rating);
        const half = rating % 1 >= 0.5 ? 1 : 0;
        const empty = 5 - full - half;
        return '‚òÖ'.repeat(full) + (half ? '‚òÜ' : '') + '‚òÜ'.repeat(empty - half);
    }
    
    // Lazy loading de im√°genes
    function lazyLoadImage(img) {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const image = entry.target;
                    image.src = image.dataset.src;
                    image.onload = () => {
                        image.classList.add('loaded');
                        image.previousElementSibling.style.display = 'none';
                    };
                    observer.unobserve(image);
                }
            });
        });
        observer.observe(img);
    }
    
    // Estados de UI
    function showLoading() {
        if (loadingState) loadingState.style.display = 'flex';
    }
    
    function hideLoading() {
        if (loadingState) loadingState.style.display = 'none';
    }
    
    function showEmptyState() {
        if (emptyState) emptyState.style.display = 'flex';
        if (loadMoreContainer) loadMoreContainer.style.display = 'none';
    }
    
    function hideEmptyState() {
        if (emptyState) emptyState.style.display = 'none';
    }
    
    function updateLoadMoreState(shown, total) {
        if (shown >= total) {
            loadMoreContainer.style.display = 'none';
        } else {
            loadMoreContainer.style.display = 'block';
            loadMoreInfo.textContent = `Mostrando ${shown} de ${total} productos`;
        }
    }
    
    function updateResultsCount(count) {
        if (resultsCount) {
            const plural = count === 1 ? '' : 's';
            const verb = count === 1 ? 'encontrado' : 'encontrados';
            resultsCount.textContent = `${count} producto${plural} ${verb}`;
        }
    }
    
    // Filtros m√≥viles
    function openFiltersModal() {
        filtersModal.classList.add('active');
        filtersOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
    
    function closeFiltersModal() {
        filtersModal.classList.remove('active');
        filtersOverlay.classList.remove('active');
        document.body.style.overflow = '';
    }
    
    function applyCurrentFilters() {
        // Aplicar filtros y recargar productos
        loadProducts(true);
        closeFiltersModal();
    }
    
    // Funciones globales
    window.clearAllFilters = function() {
        // Limpiar todos los filtros
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        const radios = document.querySelectorAll('input[type="radio"]');
        const inputs = document.querySelectorAll('input[type="number"]');
        
        checkboxes.forEach(cb => cb.checked = false);
        radios.forEach(radio => radio.checked = false);
        inputs.forEach(input => input.value = '');
        
        // Reset ordenamiento
        if (sortSelect) sortSelect.value = '';
        
        applyCurrentFilters();
    };
    
    // Configurar botones de a√±adir r√°pido
    function setupQuickAddButtons() {
        const quickAddBtns = document.querySelectorAll('.btn-quick-add');
        quickAddBtns.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const productId = this.getAttribute('data-product-id');
                quickAdd(productId, this);
            });
        });
    }
    
    function quickAdd(productId, btn) {
        // Simular a√±adir al carrito
        const originalText = btn.innerHTML;
        btn.innerHTML = '‚úì';
        btn.style.background = '#16a34a';
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.style.background = '';
        }, 1000);
        
        // Actualizar contador del carrito
        const cartCount = document.getElementById('cart-count');
        if (cartCount) {
            const current = parseInt(cartCount.textContent || '0');
            cartCount.textContent = current + 1;
            cartCount.style.display = 'inline';
            localStorage.setItem('cartCount', current + 1);
        }
    };
    
    function loadMoreProducts() {
        currentPage++;
        loadProducts(false);
    }
    
    function handleSortChange() {
        loadProducts(true);
    }
    
    function toggleView(view) {
        viewBtns.forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        grid.dataset.view = view;
    }
    
    // Inicializar aplicaci√≥n
    init();
});
</script>

{% endblock %}