<!doctype html>
<!-- ✅ CORRECTO - Remover clase dark hardcodeada -->
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>{% block title %}Kitaluro | Productos de Lujo{% endblock %}</title>
    <meta
      name="description"
      content="{% block description %}Kitaluro - Tu tienda de productos premium y de lujo{% endblock %}"
    />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tailwind Config -->
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: {
              sans: ["Outfit", "sans-serif"],
              serif: ["Playfair Display", "serif"],
            },
            colors: {
              gold: {
                50: "#fefce8",
                100: "#fef9c3",
                200: "#fef08a",
                300: "#fde047",
                400: "#facc15",
                500: "#eab308",
                600: "#ca8a04",
                700: "#a16207",
                800: "#854d0e",
                900: "#713f12",
              },
            },
          },
        },
      };
    </script>

    <!-- External CSS -->
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/styles.css' %}" />

    <!-- ✅ NUEVO - Script de tema ANTES de cargar el DOM -->
    <script>
      // Aplicar tema inmediatamente para evitar flash
      (function () {
        const theme = localStorage.getItem("theme");
        // Modo oscuro por defecto: solo aplicar claro si está explícitamente guardado
        if (theme === "light") {
          // No agregar clase dark
        } else {
          // Modo oscuro por defecto (sin preferencia guardada o dark guardado)
          document.documentElement.classList.add("dark");
        }
      })();
    </script>

    {% block extra_css %}{% endblock %}
  </head>

  <body
    class="bg-gray-50 dark:bg-neutral-950 text-neutral-900 dark:text-neutral-200 antialiased transition-colors duration-300 selection:bg-blue-500 selection:text-white font-sans"
  >
    <!-- ✅ Header corregido -->
    <header id="main-header" class="sticky top-0 z-50">
      {% block header %}
      <nav
        class="backdrop-blur-md bg-white/90 dark:bg-neutral-950/90 border-b border-gray-200 dark:border-neutral-800/50 shadow-sm dark:shadow-none"
      >
        <!-- Nivel 1: Logo + Search -->
        <div class="px-4 py-3 lg:py-5 flex items-center justify-between">
          <!-- Hamburger Menu Button (Mobile Only) -->
          <button
            id="menu-toggle"
            class="lg:hidden text-neutral-900 dark:text-white hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
            aria-label="Abrir menú"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"
              />
            </svg>
          </button>

          <!-- Spacer for desktop (mantiene espacio del hamburger) -->
          <div class="hidden lg:block w-6"></div>

          <!-- Logo Centrado -->
          <a
            href="{% url 'home' %}"
            class="absolute left-1/2 transform -translate-x-1/2 font-serif text-3xl lg:text-4xl font-bold text-neutral-900 dark:text-white tracking-wide hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
          >
            KITALURO
          </a>

          <!-- Theme Toggle & Search Icons -->
          <div class="flex items-center gap-3 ml-auto">
            <!-- ✅ NUEVO - Botón de toggle tema -->
            <button
              id="theme-toggle"
              class="text-neutral-700 dark:text-white hover:text-blue-500 dark:hover:text-blue-400 transition-colors"
              aria-label="Cambiar tema"
            >
              <!-- Sol (modo claro) -->
              <svg
                id="theme-icon-light"
                class="w-6 h-6 hidden dark:block"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
                ></path>
              </svg>
              <!-- Luna (modo oscuro) -->
              <svg
                id="theme-icon-dark"
                class="w-6 h-6 block dark:hidden"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"
                ></path>
              </svg>
            </button>

            <!-- Search Icon -->
            <button
              id="search-toggle"
              class="text-neutral-700 dark:text-white hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
              aria-label="Buscar"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                />
              </svg>
            </button>
          </div>
        </div>

        <!-- Nivel 2: Navigation Links (Desktop Centered) - Más separación vertical -->
        <div class="hidden lg:flex items-center justify-center pb-4 px-4">
          <div class="flex items-center justify-between w-full max-w-6xl">
            {% if request.user.is_authenticated and request.user.is_superuser %}
            <a
              href="{% url 'productos:admin_productos' %}"
              class="{% if 'admin' in request.resolver_match.url_name or request.resolver_match.url_name == 'nuevo_producto' or request.resolver_match.url_name == 'editar_producto' %}nav-link-active{% else %}text-neutral-600 dark:text-neutral-300 hover:text-neutral-900 dark:hover:text-white{% endif %} font-semibold text-lg transition-all duration-300 relative group"
            >
              ADMIN
              <span
                class="nav-underline absolute bottom-0 left-0 w-0 h-0.5 bg-blue-600 dark:bg-blue-400 group-hover:w-full transition-all duration-300"
              ></span>
            </a>
            {% endif %}
            <a
              href="{% url 'home' %}"
              class="{% if request.resolver_match.url_name == 'home' %}nav-link-active{% else %}text-neutral-600 dark:text-neutral-300 hover:text-neutral-900 dark:hover:text-white{% endif %} font-semibold text-lg transition-all duration-300 relative group"
            >
              INICIO
              <span
                class="nav-underline absolute bottom-0 left-0 w-0 h-0.5 bg-blue-600 dark:bg-blue-400 group-hover:w-full transition-all duration-300"
              ></span>
            </a>
            <!-- Mega Menu CATÁLOGO -->
            <div class="relative" id="catalogDropdown">
              <button
                id="catalogDropdownBtn"
                class="{% if 'productos' in request.resolver_match.namespace and 'admin' not in request.resolver_match.url_name and request.resolver_match.url_name != 'nuevo_producto' and request.resolver_match.url_name != 'editar_producto' %}nav-link-active{% else %}text-neutral-600 dark:text-neutral-300 hover:text-neutral-900 dark:hover:text-white{% endif %} font-semibold text-lg transition-all duration-300 relative group flex items-center gap-1.5"
              >
                CATÁLOGO
                <svg
                  class="w-4 h-4 transition-transform duration-300"
                  id="catalogChevron"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 9l-7 7-7-7"
                  />
                </svg>
                <span
                  class="nav-underline absolute bottom-0 left-0 w-0 h-0.5 bg-blue-600 dark:bg-blue-400 group-hover:w-full transition-all duration-300"
                ></span>
              </button>
            </div>
            <a
              href="{% url 'contacto' %}"
              class="{% if request.resolver_match.url_name == 'contacto' %}nav-link-active{% else %}text-neutral-600 dark:text-neutral-300 hover:text-neutral-900 dark:hover:text-white{% endif %} font-semibold text-lg transition-all duration-300 relative group"
            >
              CONTACTO
              <span
                class="nav-underline absolute bottom-0 left-0 w-0 h-0.5 bg-blue-600 dark:bg-blue-400 group-hover:w-full transition-all duration-300"
              ></span>
            </a>
          </div>
        </div>
      </nav>

      <!-- ==================== MEGA MENU PANEL (Desktop) ==================== -->
      <div
        id="megaMenuPanel"
        class="hidden lg:block absolute left-0 right-0 top-full z-40 opacity-0 invisible -translate-y-2 transition-all duration-300 ease-out"
      >
        <!-- Invisible bridge to prevent gap between nav and panel -->
        <div class="h-1"></div>
        <div
          class="bg-white/95 dark:bg-neutral-950/95 backdrop-blur-xl border-b border-gray-200/80 dark:border-neutral-800/50 shadow-2xl dark:shadow-[0_20px_60px_rgba(0,0,0,0.5)]"
        >
          <div class="max-w-7xl mx-auto px-6 py-8">
            <!-- Header del mega menu -->
            <div
              class="flex items-center justify-between mb-6 pb-4 border-b border-gray-100 dark:border-neutral-800/50"
            >
              <div class="flex items-center gap-3">
                <div
                  class="w-8 h-8 rounded-lg bg-blue-600/10 dark:bg-blue-500/10 flex items-center justify-center"
                >
                  <svg
                    class="w-4 h-4 text-blue-600 dark:text-blue-400"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
                    />
                  </svg>
                </div>
                <h3
                  class="text-sm font-semibold text-neutral-900 dark:text-white tracking-wide uppercase"
                >
                  Nuestras Categorías
                </h3>
              </div>
              <a
                href="{% url 'productos:index' %}"
                class="flex items-center gap-2 text-sm font-medium text-blue-600 dark:text-blue-400 hover:text-blue-700 dark:hover:text-blue-300 transition-colors group"
              >
                Ver todo el catálogo
                <svg
                  class="w-4 h-4 group-hover:translate-x-0.5 transition-transform"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17 8l4 4m0 0l-4 4m4-4H3"
                  />
                </svg>
              </a>
            </div>

            <!-- Grid de categorías -->
            <div
              class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3"
            >
              {% for cat in nav_categorias %}
              <a
                href="{% url 'productos:index' %}?categoria={{ cat.slug }}"
                class="mega-menu-card group relative flex flex-col p-4 rounded-xl border border-transparent hover:border-blue-200 dark:hover:border-blue-500/20 hover:bg-blue-50/50 dark:hover:bg-blue-500/5 transition-all duration-200"
              >
                <!-- Categoría nombre -->
                <div class="flex items-center gap-2.5 mb-2">
                  <span
                    class="w-2 h-2 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 dark:from-blue-400 dark:to-blue-500 flex-shrink-0 group-hover:scale-125 transition-transform duration-200"
                  ></span>
                  <span
                    class="font-semibold text-sm text-neutral-800 dark:text-neutral-200 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors truncate"
                  >
                    {{ cat.nombre }}
                  </span>
                </div>
                <!-- Subcategorías preview -->
                {% if cat.subcategorias.all %}
                <div class="ml-4.5 space-y-0.5">
                  {% for sub in cat.subcategorias.all|slice:":3" %}
                  <p
                    class="text-xs text-neutral-400 dark:text-neutral-500 group-hover:text-neutral-500 dark:group-hover:text-neutral-400 transition-colors truncate"
                  >
                    {{ sub.nombre }}
                  </p>
                  {% endfor %} {% if cat.subcategorias.count > 3 %}
                  <p
                    class="text-xs text-blue-500/60 dark:text-blue-400/40 font-medium"
                  >
                    +{{ cat.subcategorias.count|add:"-3" }} más
                  </p>
                  {% endif %}
                </div>
                {% else %}
                <p
                  class="ml-4.5 text-xs text-neutral-400 dark:text-neutral-600 italic"
                >
                  Explorar
                </p>
                {% endif %}
                <!-- Hover arrow -->
                <svg
                  class="absolute top-4 right-3 w-4 h-4 text-blue-500 dark:text-blue-400 opacity-0 -translate-x-1 group-hover:opacity-100 group-hover:translate-x-0 transition-all duration-200"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
              </a>
              {% empty %}
              <div class="col-span-full text-center py-8">
                <p class="text-neutral-400 dark:text-neutral-500">
                  No hay categorías disponibles
                </p>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <!-- Mobile Sidebar Menu (Hamburger Lateral Lujoso) -->
      <div id="mobile-menu" class="fixed inset-0 z-[100] pointer-events-none">
        <!-- Overlay -->
        <div
          id="menu-overlay"
          class="absolute inset-0 bg-black/60 backdrop-blur-sm opacity-0 transition-opacity duration-300"
        ></div>

        <!-- Sidebar -->
        <div
          id="menu-sidebar"
          class="absolute left-0 top-0 h-full w-80 max-w-[85vw] bg-white dark:bg-neutral-900/95 dark:glass-panel shadow-2xl dark:shadow-none backdrop-blur-md transform -translate-x-full transition-transform duration-300 ease-out"
        >
          <!-- Header del Sidebar -->
          <div class="p-6 border-b border-gray-200 dark:border-neutral-800/50">
            <div class="flex items-center justify-between">
              <h2
                class="font-serif text-4xl font-bold text-neutral-900 dark:text-white tracking-wide"
              >
                KITALURO
              </h2>
              <button
                id="menu-close"
                class="text-neutral-500 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-white transition-colors"
                aria-label="Cerrar menú"
              >
                <svg
                  class="w-6 h-6"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                  />
                </svg>
              </button>
            </div>
            <p class="text-neutral-500 dark:text-neutral-400 text-sm mt-2">
              Premium Home Technology
            </p>
          </div>

          <!-- Navigation Links -->
          <nav class="p-6">
            <ul class="space-y-2">
              {% if request.user.is_authenticated and request.user.is_superuser
              %}
              <li>
                <a
                  href="{% url 'productos:admin_productos' %}"
                  class="flex items-center gap-4 px-4 py-3 rounded-lg {% if 'admin' in request.resolver_match.url_name or request.resolver_match.url_name == 'nuevo_producto' or request.resolver_match.url_name == 'editar_producto' %}nav-link-active{% else %}text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 hover:bg-blue-50 dark:hover:bg-blue-900/20{% endif %} transition-all duration-300 group"
                >
                  <svg
                    class="w-5 h-5 group-hover:tech-glow-subtle"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                    />
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                    />
                  </svg>
                  <span class="font-bold">ADMIN</span>
                </a>
              </li>
              {% endif %}
              <li>
                <a
                  href="{% url 'home' %}"
                  class="flex items-center gap-4 px-4 py-3 rounded-lg {% if request.resolver_match.url_name == 'home' %}nav-link-active{% else %}text-neutral-700 dark:text-neutral-300 hover:text-neutral-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-neutral-800/50{% endif %} transition-all duration-300 group"
                >
                  <svg
                    class="w-5 h-5 text-blue-600 dark:text-blue-400 group-hover:tech-glow-subtle"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
                    />
                  </svg>
                  <span class="font-semibold">INICIO</span>
                </a>
              </li>
              <li>
                <div class="flex items-center">
                  <a
                    href="{% url 'productos:index' %}"
                    class="flex-1 flex items-center gap-4 px-4 py-3 rounded-lg {% if 'productos' in request.resolver_match.namespace and 'admin' not in request.resolver_match.url_name and request.resolver_match.url_name != 'nuevo_producto' and request.resolver_match.url_name != 'editar_producto' %}nav-link-active{% else %}text-neutral-700 dark:text-neutral-300 hover:text-neutral-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-neutral-800/50{% endif %} transition-all duration-300 group"
                  >
                    <svg
                      class="w-5 h-5 text-blue-600 dark:text-blue-400 group-hover:tech-glow-subtle"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"
                      />
                    </svg>
                    <span class="font-semibold">CATÁLOGO</span>
                  </a>
                  <button
                    id="mobileCatToggle"
                    class="p-3 rounded-lg text-neutral-500 dark:text-neutral-400 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-500/10 transition-all"
                    aria-label="Ver categorías"
                  >
                    <svg
                      id="mobileCatChevron"
                      class="w-5 h-5 transition-transform duration-300"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M19 9l-7 7-7-7"
                      />
                    </svg>
                  </button>
                </div>
                <!-- Categorías mobile (colapsable con animación) -->
                <div
                  id="mobileCatList"
                  class="overflow-hidden transition-all duration-300 ease-out"
                  style="max-height: 0"
                >
                  <ul
                    class="ml-6 mt-1 mb-2 space-y-0.5 border-l-2 border-blue-500/20 dark:border-blue-400/10 pl-3"
                  >
                    {% for cat in nav_categorias %}
                    <li>
                      <a
                        href="{% url 'productos:index' %}?categoria={{ cat.slug }}"
                        class="flex items-center gap-2.5 px-3 py-2 rounded-lg text-sm text-neutral-600 dark:text-neutral-400 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50/50 dark:hover:bg-blue-500/5 transition-all"
                      >
                        <span
                          class="w-1.5 h-1.5 rounded-full bg-blue-500/40 dark:bg-blue-400/30 flex-shrink-0 mt-0.5 self-start"
                        ></span>
                        <span class="flex flex-col">
                          <span class="font-medium">{{ cat.nombre }}</span>
                          {% if cat.subcategorias.all %}
                          <span class="flex flex-wrap gap-x-2 gap-y-0.5 mt-0.5">
                            {% for sub in cat.subcategorias.all %}
                            <span
                              class="text-xs text-neutral-400 dark:text-neutral-500"
                              >{{ sub.nombre }}{% if not forloop.last %},{%
                              endif %}</span
                            >
                            {% endfor %}
                          </span>
                          {% endif %}
                        </span>
                      </a>
                    </li>
                    {% endfor %}
                  </ul>
                </div>
              </li>
              <li>
                <a
                  href="{% url 'contacto' %}"
                  class="flex items-center gap-4 px-4 py-3 rounded-lg {% if request.resolver_match.url_name == 'contacto' %}nav-link-active{% else %}text-neutral-700 dark:text-neutral-300 hover:text-neutral-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-neutral-800/50{% endif %} transition-all duration-300 group"
                >
                  <svg
                    class="w-5 h-5 text-blue-600 dark:text-blue-400 group-hover:tech-glow-subtle"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
                    />
                  </svg>
                  <span class="font-semibold">CONTACTO</span>
                </a>
              </li>
            </ul>
          </nav>

          <!-- Footer del Sidebar -->
          <div
            class="absolute bottom-0 left-0 right-0 p-6 border-t border-gray-200 dark:border-neutral-800/50"
          >
            <div
              class="flex items-center gap-2 text-neutral-500 dark:text-neutral-500 text-xs"
            >
              <div
                class="w-2 h-2 bg-blue-600 dark:bg-blue-400 rounded-full animate-pulse"
              ></div>
              <span>Conectado</span>
            </div>
          </div>
        </div>
      </div>

      <!-- JavaScript para el menú y tema -->
      <script>
        document.addEventListener("DOMContentLoaded", function () {
          const themeToggle = document.getElementById("theme-toggle");
          const htmlElement = document.documentElement;

          // Toggle del tema
          themeToggle?.addEventListener("click", () => {
            const isDark = htmlElement.classList.contains("dark");

            if (isDark) {
              htmlElement.classList.remove("dark");
              localStorage.setItem("theme", "light");
            } else {
              htmlElement.classList.add("dark");
              localStorage.setItem("theme", "dark");
            }
          });

          // Mobile Menu
          const menuToggle = document.getElementById("menu-toggle");
          const menuClose = document.getElementById("menu-close");
          const mobileMenu = document.getElementById("mobile-menu");
          const menuOverlay = document.getElementById("menu-overlay");
          const menuSidebar = document.getElementById("menu-sidebar");

          function openMenu() {
            mobileMenu.classList.remove("pointer-events-none");
            mobileMenu.classList.add("pointer-events-auto");
            setTimeout(() => {
              menuOverlay.style.opacity = "1";
              menuSidebar.style.transform = "translateX(0)";
            }, 10);
            document.body.style.overflow = "hidden";
          }

          function closeMenu() {
            menuOverlay.style.opacity = "0";
            menuSidebar.style.transform = "translateX(-100%)";
            setTimeout(() => {
              mobileMenu.classList.remove("pointer-events-auto");
              mobileMenu.classList.add("pointer-events-none");
            }, 300);
            document.body.style.overflow = "";
          }

          menuToggle.addEventListener("click", openMenu);
          menuClose.addEventListener("click", closeMenu);
          menuOverlay.addEventListener("click", closeMenu);

          // Cerrar menú al hacer clic en un enlace (excepto el toggle de categorías)
          const menuLinks = menuSidebar.querySelectorAll("a");
          menuLinks.forEach((link) => {
            link.addEventListener("click", closeMenu);
          });

          // ==================== CATÁLOGO MOBILE TOGGLE ====================
          const mobileCatToggle = document.getElementById("mobileCatToggle");
          const mobileCatList = document.getElementById("mobileCatList");
          const mobileCatChevron = document.getElementById("mobileCatChevron");
          let mobileCatOpen = false;

          if (mobileCatToggle && mobileCatList) {
            mobileCatToggle.addEventListener("click", (e) => {
              e.stopPropagation();
              mobileCatOpen = !mobileCatOpen;
              if (mobileCatOpen) {
                mobileCatList.style.maxHeight =
                  mobileCatList.scrollHeight + "px";
                mobileCatChevron.style.transform = "rotate(180deg)";
              } else {
                mobileCatList.style.maxHeight = "0";
                mobileCatChevron.style.transform = "rotate(0deg)";
              }
            });
          }

          // Cerrar con tecla Escape
          document.addEventListener("keydown", function (e) {
            if (
              e.key === "Escape" &&
              !mobileMenu.classList.contains("pointer-events-none")
            ) {
              closeMenu();
            }
          });

          // ==================== CATÁLOGO MEGA MENU (Desktop) ====================
          const catalogBtn = document.getElementById("catalogDropdownBtn");
          const megaMenu = document.getElementById("megaMenuPanel");
          const catalogChevron = document.getElementById("catalogChevron");
          const catalogDropdown = document.getElementById("catalogDropdown");
          let megaOpen = false;
          let megaCloseTimeout = null;

          function openMegaMenu() {
            clearTimeout(megaCloseTimeout);
            if (megaOpen) return;
            megaOpen = true;
            megaMenu.classList.remove(
              "opacity-0",
              "invisible",
              "-translate-y-2",
            );
            megaMenu.classList.add("opacity-100", "visible", "translate-y-0");
            catalogChevron.style.transform = "rotate(180deg)";
          }

          function closeMegaMenu() {
            if (!megaOpen) return;
            megaOpen = false;
            megaMenu.classList.remove(
              "opacity-100",
              "visible",
              "translate-y-0",
            );
            megaMenu.classList.add("opacity-0", "invisible", "-translate-y-2");
            catalogChevron.style.transform = "rotate(0deg)";
          }

          function scheduleMegaClose() {
            megaCloseTimeout = setTimeout(closeMegaMenu, 200);
          }

          if (catalogBtn && megaMenu) {
            // Hover on button opens menu
            catalogDropdown.addEventListener("mouseenter", openMegaMenu);
            catalogDropdown.addEventListener("mouseleave", scheduleMegaClose);

            // Hover on mega menu keeps it open
            megaMenu.addEventListener("mouseenter", () => {
              clearTimeout(megaCloseTimeout);
            });
            megaMenu.addEventListener("mouseleave", scheduleMegaClose);

            // Click toggles
            catalogBtn.addEventListener("click", (e) => {
              e.preventDefault();
              if (megaOpen) {
                closeMegaMenu();
              } else {
                openMegaMenu();
              }
            });

            // Close on click outside
            document.addEventListener("click", (e) => {
              if (
                !catalogDropdown.contains(e.target) &&
                !megaMenu.contains(e.target)
              ) {
                closeMegaMenu();
              }
            });

            // Close on Escape
            document.addEventListener("keydown", (e) => {
              if (e.key === "Escape" && megaOpen) closeMegaMenu();
            });
          }
        });
      </script>
      {% endblock %}
    </header>

    <!-- Main Content -->
    <main id="content" class="min-h-screen">
      {% block content %}{% endblock %}
    </main>

    <!-- Search Modal -->
    <div id="search-modal" class="fixed inset-0 z-[200] pointer-events-none">
      <!-- Overlay -->
      <div
        id="search-overlay"
        class="absolute inset-0 bg-black/70 backdrop-blur-sm opacity-0 transition-opacity duration-300"
      ></div>

      <!-- Modal Content -->
      <div
        id="search-content"
        class="absolute top-0 left-1/2 -translate-x-1/2 w-full max-w-3xl transform -translate-y-full transition-transform duration-500 ease-out"
      >
        <div
          class="mx-4 mt-20 bg-white dark:bg-neutral-900 rounded-2xl shadow-2xl dark:shadow-none border border-gray-200 dark:border-neutral-800 overflow-hidden"
        >
          <!-- Search Header -->
          <div class="p-6 border-b border-gray-200 dark:border-neutral-800">
            <div class="flex items-center gap-4">
              <svg
                class="w-6 h-6 text-blue-600 dark:text-blue-400 flex-shrink-0"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                />
              </svg>
              <input
                type="text"
                id="search-input"
                placeholder="Buscar productos..."
                class="flex-1 bg-transparent text-neutral-900 dark:text-white placeholder-neutral-400 dark:placeholder-neutral-500 text-lg outline-none"
                autocomplete="off"
              />
              <button
                id="search-close"
                class="text-neutral-500 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-white transition-colors flex-shrink-0"
                aria-label="Cerrar búsqueda"
              >
                <svg
                  class="w-6 h-6"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"
                  />
                </svg>
              </button>
            </div>
          </div>

          <!-- Search Results -->
          <div id="search-results" class="max-h-[60vh] overflow-y-auto">
            <!-- Estado inicial -->
            <div id="search-empty" class="p-12 text-center">
              <svg
                class="w-16 h-16 mx-auto mb-4 text-neutral-300 dark:text-neutral-700"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                />
              </svg>
              <p class="text-neutral-500 dark:text-neutral-400">
                Comienza a escribir para buscar productos
              </p>
            </div>

            <!-- Loading -->
            <div id="search-loading" class="hidden p-12 text-center">
              <div
                class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 dark:border-blue-400"
              ></div>
              <p class="mt-4 text-neutral-600 dark:text-neutral-400">
                Buscando...
              </p>
            </div>

            <!-- No results -->
            <div id="search-no-results" class="hidden p-12 text-center">
              <svg
                class="w-16 h-16 mx-auto mb-4 text-neutral-300 dark:text-neutral-700"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              <p
                class="text-neutral-600 dark:text-neutral-400 font-medium mb-2"
              >
                No se encontraron productos
              </p>
              <p class="text-neutral-500 dark:text-neutral-500 text-sm">
                Intenta con otros términos de búsqueda
              </p>
            </div>

            <!-- Results list -->
            <div
              id="search-results-list"
              class="divide-y divide-gray-200 dark:divide-neutral-800"
            ></div>
          </div>

          <!-- Search Footer -->
          <div
            class="p-4 bg-gray-50 dark:bg-neutral-800/50 border-t border-gray-200 dark:border-neutral-800"
          >
            <div
              class="flex items-center justify-between text-xs text-neutral-500 dark:text-neutral-400"
            >
              <span id="search-count"></span>
              <span class="hidden lg:inline">Presiona ESC para cerrar</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ✅ Footer corregido -->
    <footer id="main-footer" class="bg-neutral-950 border-t border-neutral-800">
      <div class="max-w-7xl mx-auto px-4 py-6">
        <div class="text-center">
          <p class="text-neutral-400 text-sm">
            Creado por
            <a
              href="https://manulynx.github.io/M-C-Dev-Studio/"
              target="_blank"
              rel="noopener noreferrer"
              class="text-blue-400 hover:text-blue-300 transition-colors font-medium tech-glow-subtle"
            >
              M&C Dev Studio
            </a>
          </p>
        </div>
      </div>
      {% block footer %}{% endblock %}
    </footer>

    <!-- Scroll to Top Button -->
    <button
      id="scrollToTopBtn"
      class="scroll-to-top"
      aria-label="Volver arriba"
    >
      <svg
        class="w-6 h-6"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M5 10l7-7m0 0l7 7m-7-7v18"
        ></path>
      </svg>
    </button>

    <!-- Main JavaScript -->
    <script src="{% static 'js/main.js' %}"></script>

    <!-- Search Functionality -->
    <script>
      (function () {
        const searchToggle = document.getElementById("search-toggle");
        const searchModal = document.getElementById("search-modal");
        const searchOverlay = document.getElementById("search-overlay");
        const searchContent = document.getElementById("search-content");
        const searchClose = document.getElementById("search-close");
        const searchInput = document.getElementById("search-input");
        const searchEmpty = document.getElementById("search-empty");
        const searchLoading = document.getElementById("search-loading");
        const searchNoResults = document.getElementById("search-no-results");
        const searchResultsList = document.getElementById(
          "search-results-list",
        );
        const searchCount = document.getElementById("search-count");

        let searchTimeout = null;

        // Abrir modal
        function openSearch() {
          searchModal.classList.remove("pointer-events-none");
          searchModal.classList.add("pointer-events-auto");
          document.body.style.overflow = "hidden";

          setTimeout(() => {
            searchOverlay.style.opacity = "1";
            searchContent.style.transform = "translateX(-50%) translateY(0)";
            searchInput.focus();
          }, 10);
        }

        // Cerrar modal
        function closeSearch() {
          searchOverlay.style.opacity = "0";
          searchContent.style.transform = "translateX(-50%) translateY(-100%)";

          setTimeout(() => {
            searchModal.classList.remove("pointer-events-auto");
            searchModal.classList.add("pointer-events-none");
            document.body.style.overflow = "";
            searchInput.value = "";
            resetSearchResults();
          }, 300);
        }

        // Reset resultados
        function resetSearchResults() {
          searchEmpty.classList.remove("hidden");
          searchLoading.classList.add("hidden");
          searchNoResults.classList.add("hidden");
          searchResultsList.innerHTML = "";
          searchCount.textContent = "";
        }

        // Buscar productos
        function buscarProductos(query) {
          if (!query || query.length < 2) {
            resetSearchResults();
            return;
          }

          // Mostrar loading
          searchEmpty.classList.add("hidden");
          searchLoading.classList.remove("hidden");
          searchNoResults.classList.add("hidden");
          searchResultsList.innerHTML = "";

          // Hacer petición
          fetch(`/productos/api/buscar/?q=${encodeURIComponent(query)}`)
            .then((response) => response.json())
            .then((data) => {
              searchLoading.classList.add("hidden");

              if (data.success && data.productos.length > 0) {
                // Mostrar resultados
                searchCount.textContent = `${data.count} producto${
                  data.count !== 1 ? "s" : ""
                } encontrado${data.count !== 1 ? "s" : ""}`;
                searchResultsList.innerHTML = data.productos
                  .map(
                    (producto) => `
                  <a href="${
                    producto.url
                  }" class="flex gap-4 p-4 hover:bg-gray-50 dark:hover:bg-neutral-800/50 transition-colors group">
                    <div class="flex-shrink-0 w-20 h-20 bg-gray-200 dark:bg-neutral-800 rounded-lg overflow-hidden">
                      ${
                        producto.imagen
                          ? `
                        <img src="${producto.imagen}" alt="${producto.nombre}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300" />
                      `
                          : `
                        <div class="w-full h-full flex items-center justify-center text-neutral-400 dark:text-neutral-600">
                          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                          </svg>
                        </div>
                      `
                      }
                    </div>
                    <div class="flex-1 min-w-0">
                      <div class="flex items-start justify-between gap-2 mb-1">
                        <h3 class="font-semibold text-neutral-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors line-clamp-1">
                          ${producto.nombre}
                        </h3>
                        ${
                          producto.destacado
                            ? '<span class="text-xs px-2 py-1 bg-amber-500 text-white rounded-full flex-shrink-0">★</span>'
                            : ""
                        }
                      </div>
                      ${
                        producto.descripcion_corta
                          ? `<p class="text-sm text-neutral-600 dark:text-neutral-400 line-clamp-2 mb-2">${producto.descripcion_corta}</p>`
                          : ""
                      }
                      <div class="flex items-center justify-between">
                        <div class="flex items-baseline gap-2">
                          ${
                            producto.precio_oferta
                              ? `
                            <span class="text-lg font-bold text-neutral-900 dark:text-white">$${producto.precio_oferta}</span>
                            <span class="text-sm text-neutral-500 dark:text-neutral-500 line-through">$${producto.precio}</span>
                          `
                              : `
                            <span class="text-lg font-bold text-neutral-900 dark:text-white">$${producto.precio}</span>
                          `
                          }
                        </div>
                        <div class="flex items-center gap-2 text-xs">
                          ${
                            producto.categoria
                              ? `<span class="text-neutral-500 dark:text-neutral-400">${producto.categoria}</span>`
                              : ""
                          }
                          ${
                            producto.marca
                              ? `<span class="text-blue-600 dark:text-blue-400">${producto.marca}</span>`
                              : ""
                          }
                        </div>
                      </div>
                    </div>
                  </a>
                `,
                  )
                  .join("");
              } else {
                // No hay resultados
                searchNoResults.classList.remove("hidden");
                searchCount.textContent = "";
              }
            })
            .catch((error) => {
              console.error("Error al buscar:", error);
              searchLoading.classList.add("hidden");
              searchNoResults.classList.remove("hidden");
            });
        }

        // Event listeners
        searchToggle?.addEventListener("click", openSearch);
        searchClose?.addEventListener("click", closeSearch);
        searchOverlay?.addEventListener("click", closeSearch);

        // Búsqueda con debounce
        searchInput?.addEventListener("input", (e) => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            buscarProductos(e.target.value.trim());
          }, 300);
        });

        // Cerrar con ESC
        document.addEventListener("keydown", (e) => {
          if (
            e.key === "Escape" &&
            !searchModal.classList.contains("pointer-events-none")
          ) {
            closeSearch();
          }
        });

        // Cerrar al hacer clic en un resultado
        searchResultsList?.addEventListener("click", () => {
          setTimeout(closeSearch, 100);
        });
      })();
    </script>

    <!-- Image Loader Script -->
    <script src="{% static 'js/image-loader.js' %}"></script>

    {% block extra_js %}{% endblock %}
  </body>
</html>
