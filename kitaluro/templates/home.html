{% extends 'base.html' %} 
{% load static %} 
{% block title %}Kitaluro | The Future of Home{% endblock %} 
{% block content %}

<section class="lux-hero-banner">
  <div class="lux-hero-media reveal">
    <video id="heroVideo" class="lux-hero-video" autoplay muted loop playsinline preload="none" poster="{% static 'img/hero-poster.jpg' %}">
      <source src="https://res.cloudinary.com/duvfmtbb5/video/upload/v1770522751/videowebm_mjbpvg.webm" type="video/webm" />
      <source src="{% static 'video/video.mp4' %}" type="video/mp4" />
      <img src="{% static 'img/hero-poster.jpg' %}" alt="Colecci√≥n Kitaluro" />
    </video>
    <div class="lux-hero-overlay">
      <div class="lux-hero-content">
        <p class="lux-hero-kicker">Colecci√≥n 2026</p>
        <h1 class="lux-hero-title">KITALURO</h1>
        <p class="lux-hero-subtitle">Tu aliado en protecci√≥n y tecnolog√≠a</p>
        <div class="lux-hero-actions">
          <a href="{% url 'productos:index' %}" class="btn-crimson">Explorar Colecci√≥n</a>
        </div>
      </div>
    </div>
  </div>
</section>

{% include 'includes/brand_banner.html' %}

{# Importante: Los productos deben venir ordenados por 'destacado' desde la vista #}
{% regroup productos by destacado as productos_agrupados %}

{% for grupo in productos_agrupados %}
  
  {% if grupo.grouper %} 
  <section id="products" class="py-12 sm:py-16 md:py-20 lg:py-24 px-4 sm:px-6 lg:px-8 bg-gray-50 dark:bg-neutral-900">
    <div class="max-w-7xl mx-auto">
      <div class="text-center mb-8 sm:mb-12 lg:mb-16">
        <h2 class="reveal font-serif text-4xl sm:text-5xl lg:text-6xl font-bold text-neutral-900 dark:text-white mb-3 sm:mb-4">
          Destacados
        </h2>
        <p class="reveal text-neutral-600 dark:text-neutral-400 text-base sm:text-lg tracking-wide">Selecci√≥n Premium</p>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 lg:gap-8">
        {% for producto in grupo.list %}
        <div class="reveal-scale group product-card h-[420px] sm:h-[480px] lg:h-[500px] bg-white dark:bg-neutral-900/50 rounded-xl overflow-hidden shadow-xl transition-all duration-500 hover:scale-[1.02]">
          <a href="{% url 'productos:detalle' producto.slug %}" class="h-full flex flex-col">
            <div class="relative h-[60%] overflow-hidden bg-gray-100 dark:bg-neutral-800">
              {% if producto.imagen %}
                <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}" class="w-full h-full object-contain">
              {% else %}
                <img src="{% static 'img/placeholder-product.jpg' %}" class="w-full h-full object-contain">
              {% endif %}
            </div>
            <div class="h-[40%] p-4 sm:p-6 bg-white dark:bg-neutral-900 flex flex-col justify-between">
              <h3 class="font-serif text-base sm:text-lg lg:text-xl font-bold text-neutral-900 dark:text-white line-clamp-2">
                {{ producto.nombre }}
              </h3>
              <div class="flex items-baseline gap-2">
                <span class="text-lg sm:text-xl lg:text-2xl font-bold text-neutral-900 dark:text-white">${{ producto.precio_final }}</span>
                <span class="text-neutral-500 text-xs">USD</span>
              </div>
            </div>
          </a>
        </div>
        {% endfor %}
      </div>
    </div>
  </section>

  {% else %}

  <section class="reveal py-12 sm:py-16 md:py-20 lg:py-24 px-0 bg-gray-100 dark:bg-neutral-950 overflow-hidden">
    <div class="max-w-7xl mx-auto">
      <div class="text-center mb-8 sm:mb-10 lg:mb-12 px-4">
        <h2 class="font-serif text-4xl sm:text-5xl lg:text-6xl font-bold text-neutral-900 dark:text-white">Otros Productos</h2>
      </div>

      <div class="max-w-md mx-auto">
        <div id="product-carousel" class="single-card-carousel relative" style="min-height: 420px">
          {% for producto in grupo.list %}
          <div class="carousel-item absolute inset-0 w-full opacity-0 pointer-events-none" data-index="{{ forloop.counter0 }}">
            <a href="{% url 'productos:detalle' producto.slug %}" class="block bg-white dark:bg-neutral-900 rounded-xl shadow-xl h-full flex flex-col overflow-hidden">
              <div class="relative h-[220px] bg-gray-200 dark:bg-neutral-800">
                {% if producto.imagen %}
                  <img src="{{ producto.imagen.url }}" class="w-full h-full object-contain">
                {% endif %}
              </div>
              <div class="p-4 flex-grow">
                <h3 class="font-serif text-lg font-bold text-neutral-900 dark:text-white line-clamp-2">{{ producto.nombre }}</h3>
                <p class="text-lg font-bold mt-2 text-neutral-900 dark:text-white">${{ producto.precio_final }}</p>
              </div>
            </a>
          </div>
          {% endfor %}
        </div>
        
        <div class="gallery-controls mt-8">
            <button id="carousel-prev" class="gallery-control-btn prev">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6" /></svg>
            </button>
            <div class="gallery-control-divider"></div>
            <button id="carousel-playpause" class="gallery-control-btn">
                <svg class="icon-play" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5.14v14.72a.5.5 0 00.76.43l11.2-7.36a.5.5 0 000-.86L8.76 4.71a.5.5 0 00-.76.43z"/></svg>
                <svg class="icon-pause" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16" rx="1" /><rect x="14" y="4" width="4" height="16" rx="1" /></svg>
            </button>
            <div class="gallery-control-divider"></div>
            <button id="carousel-next" class="gallery-control-btn next">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6" /></svg>
            </button>
        </div>
      </div>
    </div>
  </section>
  {% endif %}

{% endfor %}

{% endblock %}
{% block extra_js %}
  <style>
    /* ======================================== */
    /* SINGLE-ITEM CAROUSEL WITH CROSSFADE     */
    /* Professional Slide + Fade Transitions   */
    /* ======================================== */

    /* Container: Single card visible at a time */
    .premium-carousel {
      position: relative;
      overflow: hidden;
      min-height: 420px;
    }

    /* Individual carousel items */
    .carousel-item {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      width: 100%;
      
      /* Default: hidden and not interactive */
      opacity: 0;
      pointer-events: none;
      
      /* Hardware acceleration */
      will-change: transform, opacity;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      
      /* Premium transition with professional easing */
      transition: transform 0.5s cubic-bezier(0.4, 0.0, 0.2, 1),
                  opacity 0.5s cubic-bezier(0.4, 0.0, 0.2, 1);
    }

    /* Active card: visible and interactive */
    .carousel-item.is-active {
      opacity: 1;
      transform: translateX(0);
      pointer-events: auto;
      z-index: 2;
    }

    /* Entering card: slide in from right */
    .carousel-item.is-entering {
      opacity: 0;
      transform: translateX(20px);
      z-index: 1;
    }

    /* Exiting card: slide out to left */
    .carousel-item.is-exiting {
      opacity: 0;
      transform: translateX(-20px);
      pointer-events: none;
      z-index: 0;
    }

    /* Active card enhancements */
    .carousel-item.is-active a {
      box-shadow: 0 30px 60px -15px rgba(0, 0, 0, 0.25),
        0 0 0 1px rgba(59, 130, 246, 0.15), 
        0 0 40px rgba(59, 130, 246, 0.1);
      border-color: rgba(59, 130, 246, 0.3) !important;
    }

    .dark .carousel-item.is-active a {
      box-shadow: 0 30px 60px -15px rgba(0, 0, 0, 0.5),
        0 0 0 1px rgba(59, 130, 246, 0.25), 0 0 50px rgba(59, 130, 246, 0.15);
    }

    /* Active card image effects */
    .carousel-item.is-active img {
      transform: scale(1);
      filter: contrast(1.02) saturate(1.05);
      transition: all 0.8s cubic-bezier(0.25, 1, 0.5, 1);
    }

    /* Inactive card image */
    .carousel-item:not(.is-active) img {
      transform: scale(1);
      filter: contrast(1) saturate(1);
      transition: all 0.6s cubic-bezier(0.25, 1, 0.5, 1);
    }

    /* Hover effects only on active card */
    .carousel-item.is-active:hover {
      transform: scale(1.02) translateZ(10px);
    }

    .carousel-item.is-active:hover a {
      box-shadow: 0 35px 70px -15px rgba(0, 0, 0, 0.3),
        0 0 0 1px rgba(59, 130, 246, 0.25), 0 0 50px rgba(59, 130, 246, 0.15);
    }

    .carousel-item.is-active:hover img {
      transform: scale(1.02);
      filter: contrast(1.05) saturate(1.08) brightness(1.01);
    }

    /* Luxury glow animation for active card */
    @keyframes activeGlow {
      0%,
      100% {
        box-shadow: 0 30px 60px -15px rgba(0, 0, 0, 0.25),
          0 0 0 1px rgba(59, 130, 246, 0.15), 0 0 30px rgba(59, 130, 246, 0.08);
      }
      50% {
        box-shadow: 0 35px 70px -15px rgba(0, 0, 0, 0.3),
          0 0 0 1px rgba(59, 130, 246, 0.2), 0 0 50px rgba(59, 130, 246, 0.15);
      }
    }

    .carousel-item.is-active.is-playing a {
      animation: activeGlow 3s ease-in-out infinite;
    }

    .dark .carousel-item.is-active.is-playing a {
      animation: activeGlowDark 3s ease-in-out infinite;
    }

    @keyframes activeGlowDark {
      0%,
      100% {
        box-shadow: 0 30px 60px -15px rgba(0, 0, 0, 0.5),
          0 0 0 1px rgba(59, 130, 246, 0.2), 0 0 40px rgba(59, 130, 246, 0.12);
      }
      50% {
        box-shadow: 0 35px 70px -15px rgba(0, 0, 0, 0.6),
          0 0 0 1px rgba(59, 130, 246, 0.35), 0 0 60px rgba(59, 130, 246, 0.2);
      }
    }

    /* Snap scrolling precision */
    .carousel-item {
      scroll-snap-align: center;
      scroll-snap-stop: always;
    }

    /* Smooth scroll indicator line */
    .carousel-progress-track {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 120px;
      height: 3px;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 3px;
      overflow: hidden;
    }

    .dark .carousel-progress-track {
      background: rgba(255, 255, 255, 0.1);
    }

    .carousel-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #60a5fa);
      border-radius: 3px;
      transition: width 0.3s cubic-bezier(0.25, 1, 0.5, 1);
    }

    /* Mobile optimizations */
    @media (max-width: 640px) {
      .carousel-item {
        opacity: 0.6;
        transform: scale(0.9) translateZ(-40px);
      }

      .carousel-item.is-active {
        transform: scale(1.02) translateZ(0);
      }

      .carousel-item.is-adjacent {
        opacity: 0.65;
        transform: scale(0.94) translateZ(-25px);
      }
    }

    /* Reduced motion preference */
    @media (prefers-reduced-motion: reduce) {
      .carousel-item {
        transition: opacity 0.3s ease !important;
        transform: none !important;
        filter: none !important;
      }

      .carousel-item.is-active {
        opacity: 1;
      }

      .carousel-item:not(.is-active) {
        opacity: 0.7;
      }

      .carousel-item.is-active.is-playing a {
        animation: none !important;
      }
    }
  </style>
  
  <!-- External JavaScript for Single-Item Carousel -->
  <script src="{% static 'js/single-card-carousel.js' %}"></script>
  
  <script>
    // ========================================
    // VIDEO DEBUG
    // ========================================
    (function () {
      const video = document.getElementById("heroVideo");

      if (video) {
        console.log("üé¨ VIDEO DEBUG - Informaci√≥n del video:");
        console.log("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ");

        // Detectar errores de carga
        video.addEventListener(
          "error",
          function (e) {
            console.error("‚ùå ERROR AL CARGAR EL VIDEO");
            console.error(
              "C√≥digo de error:",
              video.error ? video.error.code : "Desconocido"
            );
            console.error(
              "Mensaje:",
              video.error ? video.error.message : "Sin mensaje"
            );

            // Intentar obtener la fuente que fall√≥
            const sources = video.querySelectorAll("source");
            sources.forEach((source, index) => {
              console.error(`Fuente ${index + 1}:`, source.src);
              console.error(`Tipo:`, source.type);
            });
          },
          true
        );

        // Cuando el video se carga correctamente
        video.addEventListener("loadeddata", function () {
          console.log("‚úÖ VIDEO CARGADO EXITOSAMENTE");
          console.log("Duraci√≥n:", video.duration, "segundos");
          console.log("Dimensiones:", video.videoWidth, "x", video.videoHeight);
        });

        // Cuando el video empieza a reproducirse
        video.addEventListener("playing", function () {
          console.log("‚ñ∂Ô∏è VIDEO REPRODUCI√âNDOSE");
        });

        // Mostrar todas las fuentes de video
        const sources = video.querySelectorAll("source");
        console.log("üìÅ Fuentes de video configuradas:");
        sources.forEach((source, index) => {
          console.log(`  ${index + 1}. ${source.type}:`);
          console.log(`     ${source.src}`);

          // Verificar si la URL es accesible
          fetch(source.src, { method: "HEAD" })
            .then((response) => {
              if (response.ok) {
                console.log(`     ‚úÖ Archivo accesible (${response.status})`);
              } else {
                console.error(
                  `     ‚ùå Error ${response.status}: Archivo no encontrado`
                );
              }
            })
            .catch((err) => {
              console.error(`     ‚ùå Error de red:`, err.message);
            });
        });

        // Mostrar poster
        console.log("üñºÔ∏è Poster:", video.poster);

        // Verificar estado de reproducci√≥n
        setTimeout(() => {
          if (video.paused) {
            console.warn("‚ö†Ô∏è El video est√° PAUSADO");
            console.log("Intentando reproducir manualmente...");

            video
              .play()
              .then(() => console.log("‚úÖ Reproducci√≥n manual exitosa"))
              .catch((err) => console.error("‚ùå Error al reproducir:", err));
          } else {
            console.log("‚úÖ El video se est√° reproduciendo autom√°ticamente");
          }
        }, 1000);

        console.log("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ");
      } else {
        console.error(
          '‚ùå No se encontr√≥ el elemento <video> con id="heroVideo"'
        );
      }
    })();
  </script>
  {% endblock %}
</section>
